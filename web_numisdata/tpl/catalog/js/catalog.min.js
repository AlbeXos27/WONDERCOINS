"use strict";var catalog={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/catalog/trigger.catalog.php",search_options:{},selected_term_table:null,filters:{},filter_op:"AND",draw_delay:1,form:null,rows_list_container:null,export_data_container:null,set_up:function(options){const self=this,rows_list_container=options.rows_list_container,export_data_container=options.export_data_container,form_items_container=options.form_items_container,psqo=options.psqo;self.rows_list_container=rows_list_container,self.export_data_container=export_data_container,self.form_items_container=form_items_container;const form_node=self.render_form();if(self.form_items_container.appendChild(form_node),psqo&&psqo.length>1){const decoded_psqo=psqo_factory.decode_psqo(psqo);decoded_psqo&&(self.form.parse_psqo_to_form(decoded_psqo),self.form_submit(form_node,{scroll_result:!0}))}else self.load_mint_list().then((function(response){const mint=response.result[Math.floor(Math.random()*response.result.length)],custom_form=new form_factory,mint_item=custom_form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",eq:"=",eq_in:"",eq_out:"",q:`["${mint.name}"]`,is_term:!0});self.form_submit(form_node,{form_items:[mint_item],scroll_result:!0})}));return!0},render_form:function(){const self=this,fragment=new DocumentFragment;self.form=self.form||new form_factory;const form_row=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:fragment});self.form.item_factory({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"global_search",eq:"MATCH",eq_in:"",eq_out:"",class_name:"global_search",parent:form_row,callback:function(form_item){const node_input=form_item.node_input,button_info=common.create_dom_element({element_type:"div",class_name:"search_operators_info",parent:node_input.parentNode});let operators_info;button_info.addEventListener("click",(function(event){if(event.stopPropagation(),operators_info)return operators_info.remove(),void(operators_info=null);operators_info=self.form.full_text_search_operators_info(),node_input.parentNode.appendChild(operators_info)})),window.addEventListener("click",(function(e){operators_info&&!node_input.contains(e.target)&&(operators_info.remove(),operators_info=null)}))}}),self.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:"Grupo Numismático",is_term:!1,parent:form_row,group_op:"$or",callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"role",name:"role",label:tstring.role||"Role",q_column:"ref_type_creators_roles",value_split:"|",q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog",value_splittable:!0})}}),self.form.item_factory({id:"creator",name:"creator",label:tstring.creator||"creator",q_column:"ref_type_creators_full_name",q_selected_eq:"LIKE",value_split:" | ",eq_in:"%",eq_out:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog",value_splittable:!0})}}),self.form.item_factory({id:"design_obverse",name:"design_obverse",label:tstring.design_obverse||"design obverse",q_column:"ref_type_design_obverse",eq_in:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"design_reverse",name:"design_reverse",label:tstring.design_reverse||"design reverse",q_column:"ref_type_design_reverse",eq_in:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"legend_obverse",name:"legend_obverse",label:tstring.legend_obverse||"legend obverse",q_column:"CONCAT(ref_type_legend_obverse, ' | ', ref_type_legend_transcription_obverse)",q_column_filter:"ref_type_legend_transcription_obverse",eq_in:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"legend_reverse",name:"legend_reverse",label:tstring.legend_reverse||"legend reverse",q_column:"CONCAT(ref_type_legend_reverse, ' | ', ref_type_legend_transcription_reverse)",q_column_filter:"ref_type_legend_transcription_reverse",eq_in:"%",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"territory",name:"territory",label:tstring.territory||"territory",q_column:"p_territory",q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"group",name:"group",label:"Catálogo",q_column:"p_group",eq_in:"%",is_term:!0,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"material",name:"material",q_column:"ref_type_material",q_table:"any",label:tstring.material||"material",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"catalog"})}}),self.form.item_factory({id:"range_slider",name:"range_slider",input_type:"range_slider",label:tstring.period||"Period",class_name:"range_slider",q_column:"ref_date_in,ref_date_end",sql_filter:null,parent:form_row,callback:function(form_item){const node_input=form_item.node_input,range_slider_value_in=node_input.parentNode.querySelector("#range_slider_in"),range_slider_value_out=node_input.parentNode.querySelector("#range_slider_out");function set_up_slider(){self.get_catalog_range_years().then((function(range_data){$(node_input).slider("instance")&&$(node_input).slider("destroy"),form_item.sql_filter=null,range_slider_value_in.value=range_data.min,range_slider_value_in.addEventListener("change",(function(e){const value=e.target.value>=range_data.min?e.target.value:range_data.min;$(node_input).slider("values",0,value),e.target.value=value})),range_slider_value_out.value=range_data.max,range_slider_value_out.addEventListener("change",(function(e){const value=e.target.value<=range_data.max?e.target.value:range_data.max;$(node_input).slider("values",1,e.target.value),e.target.value=value})),$(node_input).slider({range:!0,min:range_data.min,max:range_data.max,step:1,values:[range_data.min,range_data.max],slide:function(event,ui){range_slider_value_in.value=ui.values[0],range_slider_value_out.value=ui.values[1]},change:function(event,ui){form_item.sql_filter="(ref_date_in >= "+ui.values[0]+" AND ref_date_in <= "+ui.values[1]+")",form_item.q=ui.value}})}))}set_up_slider()}}),self.form.item_factory({id:"ref_type_design_obverse_iconography_data",name:"ref_type_design_obverse_iconography_data",class_name:"hide",label:tstring.ref_type_design_obverse_iconography_data||"Design obverse iconography ID",q_column:"ref_type_design_obverse_iconography_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:form_row,callback:function(form_item){function fn_check_value(){form_item.q&&form_item.q.length>0?(form_item.node_input.parentNode.classList.remove("hide"),form_item.node_input.parentNode.querySelector("input").classList.remove("hide")):form_item.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",fn_check_value)}}),self.form.item_factory({id:"ref_type_design_reverse_iconography_data",name:"ref_type_design_reverse_iconography_data",class_name:"hide",label:tstring.ref_type_design_reverse_iconography_data||"Design reverse iconography ID",q_column:"ref_type_design_reverse_iconography_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:form_row,callback:function(form_item){function fn_check_value(){form_item.q&&form_item.q.length>0?(form_item.node_input.parentNode.classList.remove("hide"),form_item.node_input.parentNode.querySelector("input").classList.remove("hide")):form_item.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",fn_check_value)}}),self.form.item_factory({id:"ref_type_symbol_obverse_data",name:"ref_type_symbol_obverse_data",class_name:"hide",label:tstring.ref_type_symbol_obverse_data||"Symbol obverse ID",q_column:"ref_type_symbol_obverse_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:form_row,callback:function(form_item){function fn_check_value(){form_item.q&&form_item.q.length>0?(form_item.node_input.parentNode.classList.remove("hide"),form_item.node_input.parentNode.querySelector("input").classList.remove("hide")):form_item.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",fn_check_value)}}),self.form.item_factory({id:"ref_type_symbol_reverse_data",name:"ref_type_symbol_reverse_data",class_name:"hide",label:tstring.ref_type_symbol_reverse_data||"Symbol reverse ID",q_column:"ref_type_symbol_reverse_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:form_row,callback:function(form_item){function fn_check_value(){form_item.q&&form_item.q.length>0?(form_item.node_input.parentNode.classList.remove("hide"),form_item.node_input.parentNode.querySelector("input").classList.remove("hide")):form_item.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",fn_check_value)}});const submit_group=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:fragment}),submit_button=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:submit_group});submit_button.addEventListener("click",(function(e){e.preventDefault(),self.form_submit(form)}));const reset_button=common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:submit_group});reset_button.addEventListener("click",(function(e){e.preventDefault(),window.location.replace(window.location.pathname)}));const operators_node=self.form.build_operators_node();fragment.appendChild(operators_node);const form=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return form.appendChild(fragment),form},load_mint_list:function(){const js_promise=data_manager.request({body:{dedalo_get:"records",table:"catalog",ar_fields:["section_id","term AS name","parents"],lang:page_globals.WEB_CURRENT_LANG_CODE,limit:0,count:!1,order:"term ASC",sql_filter:"term_table='mints'"}});return js_promise},form_submit:function(form_obj,options={}){const self=this,scroll_result="boolean"!=typeof options.scroll_result||options.scroll_result,form_items=options.form_items||self.form.form_items,container_rows_list=self.rows_list_container,div_result=container_rows_list.parentNode,spinner=common.create_dom_element({element_type:"div",class_name:"spinner",parent:div_result});container_rows_list.classList.add("loading");const filter=self.form.build_filter({form_items:form_items});if(!filter||filter.length<1)return spinner.remove(),container_rows_list.classList.remove("loading"),!1;if(!self.export_data_buttons){self.export_data_buttons=page.render_export_data_buttons(),self.export_data_container.appendChild(self.export_data_buttons),self.export_data_container.classList.add("hide");const contact_form_button=page.create_suggestions_button();self.export_data_container.appendChild(contact_form_button)}div_result&&!0===scroll_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"});const js_promise=self.search_rows({filter:filter,limit:300,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then(parsed_data=>{const types_parsed_data=parsed_data.filter(item=>"types"===item.term_table&&null!=item.p_group),set_group_parsed_data=new Set;for(let index=0;index<types_parsed_data.length;index++)set_group_parsed_data.add(JSON.parse(types_parsed_data[index].p_group)[0]);const keys_group=Array.from(set_group_parsed_data),structure_tree={};for(let index=0;index<keys_group.length;index++){const base_key={people:{},no_people:{mints:{},no_mints:[]}};structure_tree[keys_group[index]]=base_key}const set_people_parsed_data=new Set;let types_without_people=0;for(let index=0;index<types_parsed_data.length;index++)null!=types_parsed_data[index].ref_type_creators_names&&types_parsed_data[index].ref_type_creators_roles&&types_parsed_data[index].ref_type_creators_roles.includes("Autoridad")?set_people_parsed_data.add(types_parsed_data[index]):types_without_people+=1;const array_people_data=Array.from(set_people_parsed_data);for(this.get_authors_from_find(array_people_data,structure_tree),this.get_mints_from_find(types_parsed_data,structure_tree),this.get_types_from_find(types_parsed_data,structure_tree);container_rows_list.hasChildNodes();)container_rows_list.removeChild(container_rows_list.lastChild);container_rows_list.classList.remove("loading"),spinner.remove(),self.draw_rows({target:self.rows_list_container,ar_rows:parsed_data,structure_tree:structure_tree}).then((function(){self.export_data_container.classList.remove("hide")}))});return js_promise},search_rows:function(options){const self=this,filter=options.filter||null,ar_fields=options.ar_fields||["*"],order=options.order||"norder ASC",lang=page_globals.WEB_CURRENT_LANG_CODE,process_result=options.process_result||null,limit=null!=options.limit?options.limit:30;return new Promise((function(resolve){const group=[];let parsed_filter=self.form.parse_sql_filter(filter,group,!0),sql_filter=parsed_filter?"("+parsed_filter+")":null;const filter_values=self.obtain_values_filter(filter);(sql_filter.includes("`p_group`")||"number"==filter_values.id)&&(sql_filter=`parents_text LIKE '%${filter_values.q}%' `),console.log("sql_filter_catalog",sql_filter),SHOW_DEBUG;const request_body={dedalo_get:"records",table:"catalog",ar_fields:ar_fields,lang:lang,sql_filter:sql_filter,limit:limit,count:!1,order:order,process_result:process_result};data_manager.request({body:request_body}).then(response=>{console.log("--- search_rows API response:",response);const data=page.parse_catalog_data(response.result);event_manager.publish("data_request_done",{request_body:request_body,result:data,export_data_parser:page.export_parse_catalog_data,filter:filter}),resolve(data)})}))},obtain_values_filter:function(filter){if("object"==typeof filter&&null!==filter&&Object.keys(filter).length<2){const primeraClave=Object.keys(filter)[0];return this.obtain_values_filter(filter[primeraClave])}return filter},draw_rows:function(options){const self=this,target=options.target,ar_rows=options.ar_rows||[],structure_tree=options.structure_tree||[];return new Promise((function(resolve){const container=target,ar_rows_length=ar_rows.length;if(ar_rows_length<1){for(;container.hasChildNodes();)container.removeChild(container.lastChild);return common.create_dom_element({element_type:"div",class_name:"no_results_found",inner_html:tstring.no_results_found||"No results found",parent:container}),window.scrollTo(0,0),resolve(container),!1}for(;container.hasChildNodes();)container.removeChild(container.lastChild);const numismatic_group_fields=Object.keys(structure_tree);for(let index=0;index<numismatic_group_fields.length;index++)self.render_numismatic_group(structure_tree,numismatic_group_fields[index],container);return image_gallery.set_up({galleryNode:container}),resolve(container),!0}))},render_numismatic_group:function(structure_tree,numismatic_group,container){const numismatic_group_div=common.create_dom_element({element_type:"div",class_name:"numismatic_group",inner_html:numismatic_group||"Sin grupo asociado",parent:container});numismatic_group_div.addEventListener("click",e=>{e.stopPropagation();const children=numismatic_group_div.querySelectorAll(":scope > .people, :scope > .mint_div");children.forEach(child=>{child.style.display="none"===child.style.display?"block":"none"})}),this.render_people_numismatic_group(structure_tree[numismatic_group],numismatic_group_div)},render_people_numismatic_group:function(numismatic_group,container){const people_numismatic_group=Object.keys(numismatic_group.people);for(let index=0;index<people_numismatic_group.length;index++){const person_numismatic_group=people_numismatic_group[index],people_numismatic_group_div=common.create_dom_element({element_type:"div",class_name:"people",inner_html:person_numismatic_group||"Sin grupo asociado",parent:container});people_numismatic_group_div.style.paddingLeft="1.5em",people_numismatic_group_div.style.color="#2d8525";const mints_person_numismatic_group=Object.keys(numismatic_group.people[person_numismatic_group].mints);people_numismatic_group_div.addEventListener("click",e=>{e.stopPropagation();const children=people_numismatic_group_div.querySelectorAll(":scope > .mint_div, :scope > .row_node");children.forEach(child=>{child.style.display="none"===child.style.display?"block":"none"})});for(let j=0;j<mints_person_numismatic_group.length;j++){const mint_person=mints_person_numismatic_group[j];this.render_mints_numismatic_group(numismatic_group.people[person_numismatic_group].mints[mint_person],mint_person,people_numismatic_group_div)}for(let j=0;j<numismatic_group.people[person_numismatic_group].no_mints.length;j++)people_numismatic_group_div.appendChild(this.render_rows(numismatic_group.people[person_numismatic_group].no_mints[j],numismatic_group.people[person_numismatic_group].no_mints))}const mints_no_people_numismatic_group=Object.keys(numismatic_group.no_people.mints);for(let index=0;index<mints_no_people_numismatic_group.length;index++){const mint=mints_no_people_numismatic_group[index];this.render_mints_numismatic_group(numismatic_group.no_people.mints[mint],mint,container)}},render_mints_numismatic_group:function(types_mint,mint,container){const mints_person_numismatic_group_div=common.create_dom_element({element_type:"div",class_name:"mint_div",inner_html:mint||"Sin grupo asociado",parent:container});mints_person_numismatic_group_div.style.paddingLeft="1.5em",mints_person_numismatic_group_div.style.color="#e2c832",mints_person_numismatic_group_div.addEventListener("click",e=>{if(e.stopPropagation(),e.target!==mints_person_numismatic_group_div)return;const children=mints_person_numismatic_group_div.querySelectorAll(":scope > .row_node");children.forEach(child=>{child.style.display="none"===child.style.display?"block":"none"})});for(let index=0;index<types_mint.length;index++)mints_person_numismatic_group_div.appendChild(this.render_rows(types_mint[index],types_mint))},render_rows:function(row_object,ar_rows){const self=this;SHOW_DEBUG,catalog_row_fields.ar_rows=ar_rows,catalog_row_fields.rows_painted=[];const node=catalog_row_fields.draw_item(row_object,this.rows_list_container);return node},get_catalog_range_years:function(){return new Promise((function(resolve){const ar_fields=["id","section_id","MIN(ref_date_in + 0) AS min","MAX(ref_date_in + 0) AS max"],request_body={dedalo_get:"records",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,table:"catalog",ar_fields:ar_fields,limit:0,count:!1,offset:0,order:"id ASC"};data_manager.request({body:request_body}).then((function(api_response){let min=0,max=0;if(api_response.result)for(let i=0;i<api_response.result.length;i++){const row=api_response.result[i],current_min=parseInt(row.min);(0===min||current_min<min)&&(min=current_min);const current_max=parseInt(row.max);max=current_max}const data={min:min,max:max};resolve(data)}))}))},get_authors_from_find:function(array_people_data,structure_tree){for(let index=0;index<array_people_data.length;index++){const author=this.get_author(array_people_data[index]),numismatic_group=JSON.parse(array_people_data[index].p_group)[0];if(!(author in structure_tree[numismatic_group].people)&&null!=author){const people_base={mints:{},no_mints:[]};structure_tree[numismatic_group].people[author]=people_base}}},get_author:function(type_data){let creators_data_parsed=null;try{creators_data_parsed=JSON.parse(type_data.ref_type_creators_data)}catch(e){return null}if(!creators_data_parsed||0===creators_data_parsed.length)return null;const roles_raw=type_data.ref_type_creators_roles||"",names_raw=type_data.ref_type_creators_names||"",creators_roles=roles_raw.split(" | "),creators_names=names_raw.split(" | ");if(creators_data_parsed.length>1){const index_author=creators_roles.findIndex(r=>r&&r.includes("Autoridad emisora"));return index_author>=0&&creators_names[index_author]?creators_names[index_author]:null}return creators_names[0]||null},get_mints_from_find:function(types_parsed_data,structure_tree){for(let index=0;index<types_parsed_data.length;index++){const author=this.get_author(types_parsed_data[index]),numismatic_group=JSON.parse(types_parsed_data[index].p_group)[0],p_mint=types_parsed_data[index].p_mint,mint_type=Array.isArray(p_mint)?p_mint[0]:null;if(author)try{mint_type in structure_tree[numismatic_group].people[author].mints||null==mint_type||(structure_tree[numismatic_group].people[author].mints[mint_type]=[])}catch(error){console.log(structure_tree[numismatic_group].people)}else mint_type&&(structure_tree[numismatic_group].no_people.mints[mint_type]=[])}},get_types_from_find:function(types_parsed_data,structure_tree){for(let index=0;index<types_parsed_data.length;index++){const author=this.get_author(types_parsed_data[index]),numismatic_group=JSON.parse(types_parsed_data[index].p_group)[0],p_mint=types_parsed_data[index].p_mint,mint_type=Array.isArray(p_mint)&&p_mint.length>0?p_mint[0]:void 0;author?(structure_tree[numismatic_group].people[author]||(structure_tree[numismatic_group].people[author]={mints:{},no_mints:[]}),mint_type?(structure_tree[numismatic_group].people[author].mints[mint_type]||(structure_tree[numismatic_group].people[author].mints[mint_type]=[]),structure_tree[numismatic_group].people[author].mints[mint_type].push(types_parsed_data[index])):structure_tree[numismatic_group].people[author].no_mints.push(types_parsed_data[index])):mint_type?(structure_tree[numismatic_group].no_people.mints[mint_type]||(structure_tree[numismatic_group].no_people.mints[mint_type]=[]),structure_tree[numismatic_group].no_people.mints[mint_type].push(types_parsed_data[index])):structure_tree[numismatic_group].no_people.no_mints.push(types_parsed_data[index])}}};