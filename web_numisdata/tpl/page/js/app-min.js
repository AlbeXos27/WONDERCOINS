"use strict";var common={get_json_data:function(e,t,n){const o=e+"?d="+Date.now(),r=JSON.stringify(t);var i=-1!=navigator.userAgent.indexOf("MSIE"),a=/rv:11.0/i.test(navigator.userAgent);if(i||a){var s=tstring.incompatible_browser||"Warning: Internet explorer is not supported. Please use a modern browser like Chrome, Firefox, Safari, Opera, Edje..";return alert(s),!1}return void 0===n&&(n=!0),new Promise((function(e,t){var i=new XMLHttpRequest;i.open("POST",o,n),i.setRequestHeader("Content-type","application/json"),i.responseType="json",i.onload=function(n){200===i.status?e(i.response):t(Error("Reject error. Data don't load. error code: "+i.statusText+" - url: "+o))},i.onerror=function(e){t(Error("There was a network error. data_send: "+o+"?"+r+"statusText: "+i.statusText))},i.send(r)}))},create_dom_element:function(e){const t=e.element_type,n=e.parent,o=e.class_name,r=e.style,i=e.data_set||e.dataset,a=e.custom_function_events,s=e.title_label||e.title,l=e.text_node,c=e.text_content,_=e.inner_html,d=e.href,u=e.id,p=e.draggable,m=e.value,f=e.download,h=e.src,g=e.placeholder,v=e.type,b=e.target,y=e.loading,w=document.createElement(t);if(u&&(w.id=u),"a"===t&&(w.href=d||"javascript:;",b&&(w.target=b)),o&&(w.className=o),r)for(q in r)w.style[q]=r[q];if(s&&(w.title=s),i)for(var q in i)w.dataset[q]=i[q];if(m&&(w.value=m),v&&w.setAttribute("type",v),a){const e=a.length;for(let t=0;t<e;t++){const e=a[t].name,n=a[t].type,o=a[t].function_arguments;this.create_custom_events(w,n,e,o)}}if(l)if("span"===t)w.textContent=l;else{const e=document.createElement("span");e.insertAdjacentHTML("afterbegin"," "+l),w.appendChild(e)}else c?w.textContent=c:_&&w.insertAdjacentHTML("afterbegin",_);return n&&n.appendChild(w),p&&(w.draggable=p),f&&w.setAttribute("download",f),h&&(w.src=h),g&&(w.placeholder=g),y&&(w.loading=y),w},build_player:function(e){!0===SHOW_DEBUG&&console.log("[common.build_player] options",e);const t=this;var n=e.type||["video/mp4"],o=e.src||[""];Array.isArray(o)||(o=[o]);const r=document.createElement("video");r.id=e.id||"video_player",r.controls=e.controls||!0,r.poster=e.poster||common.get_posterframe_from_video(o),r.className=e.class||"video-js video_hidden hide",r.preload=e.preload||"auto",r.dataset.setup="{}",e.height&&(r.height=e.height),e.width&&(r.width=e.width);for(let e=0;e<o.length;e++){const t=document.createElement("source");t.src=o[e],t.type=n[e],r.appendChild(t)}const i=e.ar_subtitles||null;if(i)for(let t=0;t<i.length;t++){const n=i[t],o=document.createElement("track");o.kind="subtitles",o.src=n.src,o.srclang=n.srclang,o.label=n.label,n.srclang===e.default&&(o.default=!0),r.appendChild(o)}const a=document.createElement("p");a.className="vjs-no-js";const s=document.createTextNode("To view this video please enable JavaScript, and consider upgrading to a web browser that supports HTML5 video");return a.appendChild(s),r.appendChild(a),setTimeout((function(){window.ready((function(n){const i=videojs(r);i.ready((function(){if(this.addClass("video_show"),this.removeClass("hide"),void 0!==e.ar_restricted_fragments&&e.ar_restricted_fragments.length>0){const n=o[0],r=parseInt(t.get_query_variable(n,"vbegin"));this.on("timeupdate",(function(n){t.skip_restricted(this,e.ar_restricted_fragments,r)}))}})),!0===e.play&&i.play()}))}),1),r},skip_restricted:function(e,t,n){const o=parseInt(e.currentTime()),r=o+parseInt(n);SHOW_DEBUG;const i=t.length;for(let a=0;a<i;a++){const i=t[a],s=i.tcin_secs,l=i.tcout_secs;if(r>s&&r<l){const t=l-n;e.currentTime(t),!0===SHOW_DEBUG&&(console.log("+++ Jumped to end time :",r,l),console.log("item:",i,"tcin_secs",n,"player_current_time",o,"time_to_jump_secs",t))}}return!0},timestamp_to_fecha:function(e){if(!e||e.length<4)return null;if(10===e.length){var t=e.substring(0,4),n=e.substring(5,7);const a=[];(r=e.substring(8,10))&&"00"!=r&&a.push(r),n&&"00"!=n&&a.push(n),t&&"00"!=t&&a.push(t);var o=a.join("-")}else{var r,i=new Date(e);t=i.getFullYear(),n=i.getMonth();function s(e){return e<10?"0"+e:e}o=s(r=i.getDate())+"-"+s(n+1)+"-"+t}return o},local_to_remote_path:function(e){if(!e)return null;if(-1===e.indexOf("http://")&&-1===e.indexOf("https://")){const t=page_globals.WEB_ENTITY;"/"!==(e=(e=e.replace("/dedalo4/","/dedalo/")).replace("/media_test/media_"+t,"/media")).charAt(0)&&(e="/"+e),e=page_globals.__WEB_MEDIA_BASE_URL__+e}return e},get_posterframe_from_video:function(e){var t=e,n=(t=(t=t.replace(/\/404\//g,"/posterframe/")).replace(/\.mp4/g,".jpg")).split("?");return void 0!==n[0]&&(t=n[0]),t},get_media_engine_url:function(e,t,n,o){const r=o?e:/^.{3,}_.{3,}_(\d{1,})\.[\S]{3,4}$/.exec(e)[1];return __WEB_MEDIA_ENGINE_URL__+"/"+t+"/"+r+(n?"/"+n:"")},open_note:function(e,t){for(var n=t.length-1;n>=0;n--){var o=t[n];if(e.dataset.tag_id===o.id)return $.colorbox({html:o.label,transition:"none"}),!0}return!1},set_background_color:function(e,t){e.setAttribute("crossOrigin","");const n=(new BackgroundColorTheif).getBackGroundColor(e);return t.style.backgroundColor="rgb("+n[0]+","+n[1]+","+n[2]+")",n},build_slider:function(e){const t=e.container;return new Promise((function(n){var o=common.create_dom_element({element_type:"ul",class_name:"slides",parent:t});const r=e.ar_elements.length;for(let t=0;t<r;t++){const r=e.ar_elements[t],c=r.image,_=r.title||null,d=r.text||null;if(!(c.length<4)){var i=common.create_dom_element({element_type:"li",class_name:"row_image",parent:o});common.create_dom_element({element_type:"div",class_name:"image_bg",parent:i}).style.backgroundImage="url("+c+")";var a=common.create_dom_element({element_type:"div",class_name:"image_text",parent:i}),s=common.create_dom_element({element_type:"h1",text_content:_,parent:a});common.create_dom_element({element_type:"a",parent:s}),common.create_dom_element({element_type:"span",text_content:d,parent:a});if(0===t){var l=new Image;l.addEventListener("load",(function(){n(o)}),!1),l.src=c}}}}))},get_scrollbar_width:function(){var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var o=n.offsetWidth;return e.parentNode.removeChild(e),t-o},has_scrollbar:function(){if("number"==typeof window.innerWidth){return window.innerWidth>=document.documentElement.clientWidth}const e=document.documentElement||document.body;var t,n;void 0!==e.currentStyle&&(t=e.currentStyle.overflow),t=t||window.getComputedStyle(e,"").overflow,void 0!==e.currentStyle&&(n=e.currentStyle.overflowY),n=n||window.getComputedStyle(e,"").overflowY;var o=e.scrollHeight>e.clientHeight,r=/^(visible|auto)$/.test(t)||/^(visible|auto)$/.test(n);return o&&r||("scroll"===t||"scroll"===n)},clone_deep:function(e){const t=this;let n,o;if("object"!=typeof e)return e;if(!e)return e;if("[object Array]"===Object.prototype.toString.apply(e)){for(n=[],o=0;o<e.length;o+=1)n[o]=t.clone_deep(e[o]);return n}for(o in n={},e)e.hasOwnProperty(o)&&(n[o]=t.clone_deep(e[o]));return n},get_query_variable:function(e,t){const n=e.split("?")[1].split("&");for(var o=0;o<n.length;o++){const e=n[o].split("=");if(e[0]==t)return e[1]}return!1},register_events:function(e,t){for(let n in t){const o=t[n];e.addEventListener(n,(function(e){for(let t in o)o[t](e)}))}return!0},clean_gaps:function(e,t=" | ",n=", "){if(!e)return"";return(e=(e=(e=e.trim()).replace(/^\| |\| {1,2}\|| \|+$/g,"")).trim()).split(t).filter((e=>e.length>0)).join(n)},when_in_dom:function(e,t){if(document.contains(e))return t();const n=new MutationObserver((function(o){document.contains(e)&&(n.disconnect(),t())}));return n.observe(document,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),n},remove_gaps:function(e,t){return e.split(t).filter(Boolean).join(t)},split_data:function(e,t){return e?e.split(t):[]},clean_date:function(e,t){const n=e?e.split(t):[],o=[];for(let e=0;e<n.length;e++){const t=n[e].split("-"),r=[];if(t[2]&&"00 00:00:00"!==t[2]){const e=t[2].split(" ")[0];r.push(e)}t[1]&&"00"!==t[1]&&r.push(t[1]),t[0]&&"0000"!==t[0]&&r.push(t[0]);const i=r.join("-");o.push(i)}return o},download_item:function(e,t){return fetch(e).then((function(e){return e.blob()})).then((function(e){const n=URL.createObjectURL(e),o=common.create_dom_element({element_type:"a",href:n,download:t||"image.jpg"});o.click(),o.remove()})),!0},is_node:function(e){return!!(e instanceof HTMLElement||e.nodeType)},is_element_in_viewport:function(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)},is_element_top_in_viewport:function(e){return e.getBoundingClientRect().top<=(window.innerHeight||document.documentElement.clientHeight)},lang_code_to_tld2:function(e){let t;switch(e){case"lg-spa":t="es";break;case"lg-eng":t="en";break;case"lg-cat":t="ca";break;case"lg-fra":t="fr";break;case"lg-ell":t="el";break;case"lg-deu":t="de";break;case"lg-por":t="pt";break;case"lg-eus":t="eu";break;case"lg-ara":t="ar";break;default:t="lang_code",console.warn("Impossible to convert lang_code to tld2 ISO 639-1 :",e)}return t},is_object:function(e){return"object"==typeof e&&null!==e},is_array:function(e){return Array.isArray(e)},get_today_date:function(){const e=new Date;return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear().toString().padStart(4,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`},uniq_fast:function(e){const t={},n=[];let o=e.length,r=0;for(let i=0;i<o;i++){const o=e[i];1!==t[o]&&(t[o]=1,n[r++]=o)}return n}};function ready(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)}




"use strict";function form_factory(){this.form_items=[],this.node=null,this.operators_node=null,this.group=[],this.item_factory=function(options){const self=this,form_item=self.build_form_item(options);return options.parent&&self.build_form_node(form_item,options.parent),"function"==typeof options.callback&&options.callback(form_item),self.form_items[options.id]=form_item,form_item},this.build_form_item=function(options){const form_item={id:options.name,name:options.name,label:options.label,class_name:options.class_name||null,q:options.q||"",q_selected:[],q_selected_eq:options.q_selected_eq||"=",q_column:options.q_column,q_column_filter:options.q_column_filter,q_column_group:options.q_column_group,q_splittable:options.q_splittable||!1,sql_filter:options.sql_filter||null,eq:options.eq||"LIKE",eq_in:void 0!==options.eq_in?options.eq_in:"",eq_out:void 0!==options.eq_out?options.eq_out:"%",is_term:options.is_term||!1,callback:options.callback||!1,list_format:options.list_format||null,wrapper:options.wrapper||null,value_wrapper:options.value_wrapper||null,value_split:options.value_split||null,node_input:null,node_values:null,input_type:options.input_type,input_values:options.input_values,group_op:options.group_op||"$and"};return form_item},this.build_form_node=function(form_item,parent){const group=common.create_dom_element({element_type:"div",class_name:"form-group field "+(form_item.class_name||""),title:form_item.is_term?form_item.label+" (is_term)":form_item.label,parent:parent});switch(form_item.input_type){case"range_slider":const range_slider_labels=common.create_dom_element({element_type:"div",class_name:"range_slider_labels",parent:group}),range_slider_value_in=common.create_dom_element({element_type:"input",type:"text",id:form_item.id+"_in",class_name:"form-control range_slider_value value_in",parent:range_slider_labels}),node_label=common.create_dom_element({element_type:"span",class_name:"form-control range_slider_label node_label",inner_html:form_item.label,parent:range_slider_labels}),range_slider_value_out=common.create_dom_element({element_type:"input",type:"text",id:form_item.id+"_out",class_name:"form-control range_slider_value value_out",parent:range_slider_labels}),node_slider=common.create_dom_element({element_type:"div",id:form_item.id,class_name:"form-control "+(form_item.class_name?" "+form_item.class_name:""),parent:group});form_item.node_input=node_slider;break;case"select":const node_select=common.create_dom_element({element_type:"select",id:form_item.id,class_name:"form-control ui-autocomplete-select"+(form_item.class_name?" "+form_item.class_name:""),value:form_item.q||"",parent:group});for(let i=0;i<form_item.input_values.length;i++)form_item.input_values[i],common.create_dom_element({element_type:"option",value:form_item.input_values[i].value,inner_html:form_item.input_values[i].label,parent:node_select});node_select.addEventListener("change",(function(e){console.log("e.target.value:",e.target.value),e.target.value&&(form_item.q=e.target.value,console.log("form_item:",form_item))})),form_item.node_input=node_select;break;default:let label_node;const node_input=common.create_dom_element({element_type:"input",type:"text",id:form_item.id,class_name:"form-control ui-autocomplete-input"+(form_item.class_name?" "+form_item.class_name:""),placeholder:form_item.label,value:form_item.q||"",parent:group});node_input.addEventListener("keyup",(function(e){form_item.q=e.target.value,node_input.value.length>0?label_node=label_node||common.create_dom_element({element_type:"span",class_name:"form_input_label",inner_html:form_item.label,parent:group}):label_node&&(label_node.remove(),label_node=null)})),node_input.addEventListener("blur",(function(e){label_node&&0===node_input.value.length&&(label_node.remove(),label_node=null)})),form_item.node_input=node_input}const node_values=common.create_dom_element({element_type:"div",class_name:"container_values",parent:group});return form_item.node_values=node_values,!0},this.build_operators_node=function(){const self=this,group=common.create_dom_element({element_type:"div",class_name:"form-group field field_operators"}),operator_label=common.create_dom_element({element_type:"span",class_name:"radio operators",text_content:tstring.operator||"Operator",parent:group}),radio1=common.create_dom_element({element_type:"input",type:"radio",id:"operator_or",parent:group});radio1.setAttribute("name","operators"),radio1.setAttribute("value","$or");const radio1_label=common.create_dom_element({element_type:"label",text_content:tstring.or||"or",parent:group});radio1_label.setAttribute("for","operator_or");const radio2=common.create_dom_element({element_type:"input",type:"radio",id:"operator_and",name:"operators",parent:group});radio2.setAttribute("name","operators"),radio2.setAttribute("value","$and"),radio2.setAttribute("checked","checked");const radio2_label=common.create_dom_element({element_type:"label",text_content:tstring.and||"and",parent:group});return radio2_label.setAttribute("for","operator_and"),this.operators_node=group,group},this.set_operator_node_value=function(operator_value){const self=this,operator="$and"===operator_value?"and":"$or"===operator_value?"or":null;if(!operator)return!1;const radio_button=this.operators_node.querySelector("#operator_"+operator);return radio_button.setAttribute("checked","checked"),!0},this.add_selected_value=function(form_item,label,value){const container=form_item.node_values,inputs=container.querySelectorAll(".input_values"),inputs_length=inputs.length;for(let i=inputs_length-1;i>=0;i--)if(value===inputs[i].value)return!1;const line=common.create_dom_element({element_type:"div",class_name:"line_value",parent:container}),trash=common.create_dom_element({element_type:"i",class_name:"icon remove fal far fa-trash fa-trash-alt",parent:line});trash.addEventListener("click",(function(){const index=form_item.q_selected.indexOf(value);index>-1&&(form_item.q_selected.splice(index,1),this.parentNode.remove(),!0===SHOW_DEBUG&&console.log("form_item.q_selected removed value:",value,form_item.q_selected))}));const value_label=common.create_dom_element({element_type:"span",class_name:"value_label",inner_html:label,parent:line}),input=common.create_dom_element({element_type:"input",class_name:"input_values",parent:line});return input.value=value,form_item.q_selected.push(value),form_item.node_input.value="",form_item.q="",!0},this.set_input_value=function(form_item,value){return form_item.node_input.value=value,form_item.q=value,!0},this.set_form_item=function(psqo_item){const self=this,q_column=psqo_item.id,form_item=self.form_items[q_column];if(!form_item)return console.error("Error on get form item",psqo_item,self.form_items),!1;form_item.op=psqo_item.op||form_item.op,form_item.eq_in=psqo_item.eq_in||form_item.eq_in,form_item.eq_out=psqo_item.eq_out||form_item.eq_out;const clean_value=psqo_item.q;if("q_selected"===psqo_item.q_type){const label=clean_value;self.add_selected_value(form_item,label,clean_value)}else self.set_input_value(form_item,clean_value);return form_item},this.build_filter=function(options={}){const self=this,form_items=options.form_items||this.form_items,ar_query_elements=[];for(let[id,form_item]of Object.entries(form_items)){const group_op=!0===form_item.is_term?"$or":form_item.group_op?form_item.group_op:"$and",group={};if(group[group_op]=[],0!==form_item.q.length&&"*"!==form_item.q||form_item.sql_filter){if("range_slider"===form_item.input_type&&(!form_item.sql_filter||form_item.sql_filter.length<2))continue;const c_group_op="$and",c_group={};c_group[c_group_op]=[];const safe_value="string"==typeof form_item.q||form_item.q instanceof String?form_item.q.replace(/(')/g,"''"):form_item.q,element={id:form_item.id,field:form_item.q_column,value:`'${form_item.eq_in}${safe_value}${form_item.eq_out}'`,op:form_item.eq,q_type:"q",q:form_item.q};form_item.sql_filter&&(element.sql_filter=form_item.sql_filter),form_item.wrapper&&(element.wrapper=form_item.wrapper),c_group[c_group_op].push(element),group[group_op].push(c_group)}if(0!==form_item.q_selected.length)for(let j=0;j<form_item.q_selected.length;j++){const value=form_item.q_selected[j],safe_value="string"==typeof value||value instanceof String?value.replace(/(')/g,"''"):value,item_value=form_item.value_wrapper&&form_item.value_wrapper.length>1?form_item.value_wrapper[0]+safe_value+form_item.value_wrapper[1]:safe_value,c_group_op="$and",c_group={};c_group[c_group_op]=[];const element={id:form_item.id,field:form_item.q_column,value:"LIKE"===form_item.q_selected_eq?`'%${item_value}%'`:`'${item_value}'`,op:form_item.q_selected_eq,q_type:"q_selected",q:value};form_item.sql_filter&&(element.sql_filter=form_item.sql_filter),form_item.wrapper&&(element.wrapper=form_item.wrapper),c_group[c_group_op].push(element),group[group_op].push(c_group)}group[group_op].length>0&&ar_query_elements.push(group)}if(SHOW_DEBUG,ar_query_elements.length<1)return console.warn("-> form_to_sql_filter empty elements selected:",ar_query_elements),!1;const input_operators=this.operators_node?this.operators_node.querySelector('input[name="operators"]'):null,operators_value=input_operators?this.operators_node.querySelector('input[name="operators"]:checked').value:"$and",filter={};return filter[operators_value]=ar_query_elements,filter},this.parse_sql_filter=function(filter,group,recursive,global_search){const self=this,sql_filter=filter?function(){const op=Object.keys(filter)[0],ar_query=filter[op],ar_filter=[],ar_query_length=ar_query.length;for(let i=0;i<ar_query_length;i++){const item=ar_query[i],item_op=Object.keys(item)[0];if("$and"===item_op||"$or"===item_op){if(recursive){const current_filter_line=""+self.parse_sql_filter(item,group,recursive);ar_filter.push(current_filter_line)}continue}const item_field=item.wrapper&&item.wrapper.length>0?item.wrapper+"("+item.field+")":item.field;let filter_line;filter_line=item.sql_filter&&item.sql_filter.length>0?item.sql_filter:"MATCH"===item.op?"MATCH ("+item_field+") AGAINST ("+item.value+" IN BOOLEAN MODE)":-1!==item_field.indexOf("AS")||-1!==item_field.indexOf("CONCAT")||item.wrapper&&item.wrapper.length>0?"("+item_field+" "+item.op+" "+item.value+" AND "+item_field+"!='')":"(`"+item_field+"` "+item.op+" "+item.value+" AND `"+item_field+"`!='')","term"==item_field&&(filter_line+=" AND term_section_label LIKE '%Grupo numismÃ¡tico%' AND parent LIKE  '[\"21057\"]'"),global_search&&(filter_line+=` OR parents_text LIKE ${item.value}`),ar_filter.push(filter_line),group&&item.group&&group.push(item.group)}const boolean_op="$and"===op?"AND":"$or"===op?"OR":null;return ar_filter.join(" "+boolean_op+" ")}():null;return sql_filter},this.parse_psqo_to_form=function(psqo,recursion){const self=this,global_key=Object.keys(psqo)[0];if("$and"===global_key||"$or"===global_key){recursion||self.set_operator_node_value(global_key);for(let i=0;i<psqo[global_key].length;i++)self.parse_psqo_to_form(psqo[global_key][i],!0)}else self.set_form_item(psqo);return!0},this.full_text_search_operators_info=function(){const grid=common.create_dom_element({element_type:"div",class_name:"full_text_search_operators_info"}),pairs=[{op:tstring.operator,info:tstring.description},{op:"+",info:tstring.include_the_word||"Include, the word must be present."},{op:"-",info:tstring.exclude_the_word||"Exclude, the word must not be present."},{op:">",info:tstring.increase_ranking||"Include, and increase ranking value."},{op:"<",info:tstring.decrease_ranking||"Include, and decrease the ranking value."},{op:"()",info:tstring.group_words||"Group words into subexpressions (allowing them to be included, excluded, ranked, and so forth as a group)."},{op:"~",info:tstring.negate_word||"Negate a wordâ€™s ranking value."},{op:"*",info:tstring.wildcard_at_end||"Wildcard at the end of the word."},{op:"â€œâ€",info:tstring.defines_phrase||"Defines a phrase (as opposed to a list of individual words, the entire phrase is matched for inclusion or exclusion)."}];for(let i=0;i<pairs.length;i++)common.create_dom_element({element_type:"div",class_name:"op",text_content:pairs[i].op,parent:grid}),common.create_dom_element({element_type:"div",class_name:"info",text_content:pairs[i].info,parent:grid});return grid},this.activate_autocomplete=function(options){const self=this,form_item=options.form_item,id=options.id||!1,label=options.label||"",limit=options.limit||30,table=options.table||form_item.table,cross_filter=options.cross_filter||!0,order=options.order||"name ASC",parent_in=options.parent_in||!1,global_search=options.global_search||!1,activate_filter=0!=options.activate_filter;console.log(options.activate_filter);const parse_result=options.parse_result||function(ar_result,term){return ar_result.map((function(item){return item.label=item.label.replace(/<br>/g," "),"function"==typeof page.parse_legend_svg&&(item.label=page.parse_legend_svg(item.label)),item}))};!function($){var proto=$.ui.autocomplete.prototype,initSource=proto._initSource;function filter(array,term){var matcher=new RegExp($.ui.autocomplete.escapeRegex(term),"i");return $.grep(array,(function(value){return matcher.test($("<div>").html(value.label||value.value||value).text())}))}$.extend(proto,{_initSource:function(){this.options.html&&$.isArray(this.options.source)?this.source=function(request,response){response(filter(this.options.source,request.term))}:initSource.call(this)},_renderItem:function(ul,item){for(var final_label=item.label,ar_parts=final_label.split(" | "),ar_clean=[],i=0;i<ar_parts.length;i++){var current=ar_parts[i];current.length>1&&"<i>.</i>"!==current&&ar_clean.push(current)}return final_label=ar_clean.join(" | "),$('<li class="ui-menu-item"></li>').data("item.autocomplete",item).append($('<div class="ui-menu-item-wrapper"></div>')[this.options.html?"html":"text"](final_label)).appendTo(ul)}})}(jQuery);const cache={};return $(form_item.node_input).autocomplete({delay:150,minLength:0,html:!0,source:async function(request,response){const term=request.term,field=form_item.q_name,q_column=form_item.q_column,q_column_group=form_item.q_column_group||q_column,op="$and",filter={$and:[]},value_parsed=form_item.eq_in+term+form_item.eq_out,safe_value="string"==typeof value_parsed||value_parsed instanceof String?value_parsed.replace(/(')/g,"''"):value_parsed;if(filter[op].push({field:form_item.q_column_filter||q_column,value:`'${safe_value}'`,op:form_item.eq,group:q_column_group}),cross_filter){const c_op="$and",c_filter={};c_filter[c_op]=[];for(let[id,current_form_item]of Object.entries(self.form_items))if(current_form_item.id!==form_item.id){if(0!==current_form_item.q.length&&"*"!==current_form_item.q||current_form_item.sql_filter){const element={field:current_form_item.q_column,value:`'%${current_form_item.q}%'`,op:"LIKE",sql_filter:current_form_item.sql_filter,wrapper:current_form_item.wrapper};c_filter[c_op].push(element)}if(0!==current_form_item.q_selected.length)for(let k=0;k<current_form_item.q_selected.length;k++){const value=current_form_item.q_selected[k],safe_value="string"==typeof value||value instanceof String?value.replace(/(')/g,"''"):value,element={field:current_form_item.q_column,value:!0===current_form_item.is_term?`'%"${safe_value}"%'`:`'${safe_value}'`,op:!0===current_form_item.is_term?"LIKE":"=",sql_filter:current_form_item.sql_filter,wrapper:current_form_item.wrapper};c_filter[c_op].push(element)}}c_filter[c_op].length>0&&filter[op].push(c_filter)}if(1===filter[op].length&&term in cache)return SHOW_DEBUG,void response(cache[term]);const sql_filter=self.parse_sql_filter(filter,self.group,activate_filter,global_search),table_resolved="function"==typeof table?table():table,field_beats=q_column.split(" AS "),plain_field=field_beats[0];let section_id="";id&&await data_manager.request({body:{dedalo_get:"records",table:table_resolved,ar_fields:[plain_field+" AS name","section_id"],sql_filter:id?" `term` LIKE '%"+label+"%'":sql_filter,group:plain_field,limit:limit,order:order}}).then(api_response=>{section_id=api_response.result[0].section_id}),await data_manager.request({body:{dedalo_get:"records",table:table_resolved,ar_fields:[plain_field+" AS name","findspots"==table_resolved||"catalog"==table_resolved?"parents_text":"section_id"],sql_filter:id?`parent LIKE  '["${section_id}"]'`:sql_filter,group:plain_field,limit:limit,order:order}}).then(async api_response=>{console.log("--\x3eautocomplete api_response:",api_response);const ar_result=[];let set_creators=new Set;const set_material=new Set,result=api_response.result,len=api_response.result.length;for(let i=0;i<len;i++){const item=api_response.result[i];if(!item.name||item.name.length<1)continue;let base_value=[];if(0===item.name.indexOf('["')&&-1!==item.name.indexOf("] | [")){const beats=item.name.split(" | "),parsed_beats=beats.map(el=>JSON.parse(el));let ar_final=[];for(let k=0;k<parsed_beats.length;k++)ar_final.concat(parsed_beats[k]);base_value=JSON.stringify(ar_final)}else base_value=item.name;const current_ar_value=0===base_value.indexOf('["')?JSON.parse(base_value):Array.isArray(base_value)?base_value:[base_value];for(let j=0;j<current_ar_value.length;j++){const item_name=current_ar_value[j],item_value=current_ar_value[j];if(item_name&&"[]"!==item_name)if(form_item.value_split){const terms=item_name.split(form_item.value_split);for(let k=0;k<terms.length;k++){const term_name=terms[k].trim(),term_name_lowercase=term_name.toLowerCase(),search_name_lowercase=request.term.toLowerCase();if(-1===term_name_lowercase.indexOf(search_name_lowercase))continue;const found=ar_result.find(el=>el.value===term_name);!found&&term_name.length>0&&!set_creators.has(term_name.split(",")[0].trim())&&(set_creators.add(term_name.split(",")[0].trim()),ar_result.push({label:term_name.split(",")[0].trim(),value:term_name.split(",")[0].trim()}))}}else{const found=ar_result.find(el=>el.value===item_name);let camino_hallazgo=" | ";if("findspots"===table_resolved){const camino_hallazgo_json=JSON.parse(item.parents_text);if(camino_hallazgo_json)for(let index=0;index<camino_hallazgo_json.length-1;index++)camino_hallazgo+=camino_hallazgo_json[index]+(index==camino_hallazgo_json.length-2?"":" | ")}if("catalog"===table_resolved&&"ref_type_material"===q_column){let name;!item_name.toLowerCase().includes("ae")&&set_material.add(item_name)}"ref_type_material"===q_column?!found&&item_value.trim().length>0&&set_material.has(item_name)&&ar_result.push({label:parent_in?item_name+camino_hallazgo:item_name,value:item_value}):!found&&item_value.trim().length>0&&ar_result.push({label:parent_in?item_name+camino_hallazgo:item_name,value:item_value})}}}const ar_result_final=parse_result(ar_result,term);1===filter[op].length&&"function"!=typeof table&&(cache[term]=ar_result_final),SHOW_DEBUG,response(ar_result_final)})},select:function(event,ui){return event.preventDefault(),self.add_selected_value(form_item,ui.item.label,ui.item.value),this.value="",!1},focus:function(){return!1},close:function(event,ui){},change:function(event,ui){},response:function(event,ui){}}).on("keydown",(function(event){event.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})),!0},this.form_to_sql_filter=function(options){console.error("WARNING! form_to_sql_filter is DEPRECATED! Use build_filter instead!");const self=this,form_node=options.form_node,form_items=this.form_items,ar_query_elements=[];for(let[id,form_item]of Object.entries(form_items)){const current_group=[],group_op="AND",group={};if(group[group_op]=[],0!==form_item.q.length){const c_group_op="AND",c_group={};c_group[c_group_op]=[];const safe_value=form_item.q.replace(/(')/g,"''"),value_parsed=form_item.eq_in+safe_value+form_item.eq_out,element={field:form_item.q_column,value:value_parsed,op:form_item.eq};c_group[c_group_op].push(element),group[group_op].push(c_group)}if(0!==form_item.q_selected.length)for(let j=0;j<form_item.q_selected.length;j++){const value=form_item.q_selected[j],safe_value=value.replace(/(')/g,"''"),c_group_op="AND",c_group={};c_group[c_group_op]=[];const element={field:form_item.q_column,value:!0===form_item.is_term?`'%"${safe_value}"%'`:`'${safe_value}'`,op:!0===form_item.is_term?"LIKE":"="};c_group[c_group_op].push(element),group[group_op].push(c_group)}group[group_op].length>0&&ar_query_elements.push(group)}if(SHOW_DEBUG,ar_query_elements.length<1)return console.warn("-> form_to_sql_filter empty elements selected:",ar_query_elements),null;const input_operators=form_node.querySelector('input[name="operators"]'),operators_value=input_operators?form_node.querySelector('input[name="operators"]:checked').value:"AND",filter={};filter[operators_value]=ar_query_elements,SHOW_DEBUG;const sql_filter=this.parse_sql_filter(filter,void 0,!0);return sql_filter}}var psqo_factory={build_safe_psqo:function(psqo){const self=this,global_key=Object.keys(psqo)[0];if("$and"!==global_key&&"$or"!==global_key)return clean_psqo_item(psqo);for(let i=0;i<psqo[global_key].length;i++)psqo[global_key][i]=self.build_safe_psqo(psqo[global_key][i]);function clean_psqo_item(psqo_item){const id=psqo_item.id,field=psqo_item.field,q=psqo_item.q,q_type=void 0!==psqo_item.q_type?psqo_item.q_type:"q",new_psqo_item={id:id,field:field,q:q,q_type:q_type};return psqo_item.op&&(new_psqo_item.op=psqo_item.op),psqo_item.eq_in&&(new_psqo_item.eq_in=psqo_item.eq_in),psqo_item.eq_out&&(new_psqo_item.eq_out=psqo_item.eq_out),new_psqo_item}return psqo},encode_psqo:function(psqo){const base=JSON.stringify(psqo);return LZString.compressToEncodedURIComponent(base)},decode_psqo:function(psqo){const parsed_psqo=(()=>{try{const base=LZString.decompressFromEncodedURIComponent(psqo);return JSON.parse(base)}catch(error){console.log("psqo:",psqo),console.warn("invalid psqo: ",error)}return null})();return parsed_psqo}};




"use strict";function map_factory(){this.map_container=[],this.map_position=null,this.source_maps=[],this.map=null,this.map_node=null,this.result=null,this.findspot=!1,this.unique=!1,this.zoom=8,this.init=function(options){const self=this;self.map_node=options.map_node||null,self.map_container=options.map_container||null,self.map_position=options.map_position||[36.5297,-6.2924],self.popup_options=options.popup_options||{},self.source_maps=options.source_maps||[],self.result=options.result||null,self.findspot=options.findspot||!1,self.unique=options.unique||!1,self.zoom=options.zoom||8;const containerElement="string"==typeof self.map_container?document.getElementById(self.map_container):self.map_container;if(!containerElement)return void console.error("Contenedor del mapa no vÃ¡lido.");self.map=L.map(containerElement,{preferCanvas:!0}).setView(self.map_position,self.zoom),self.add_layer_control(self.map,self.source_maps),self.findspot?(L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(self.map),L.tileLayer("https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png").addTo(self.map)):(L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{}).addTo(self.map),L.tileLayer("https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png",{}).addTo(self.map));const clusters=self.add_markers(self.map,self.result,self.map_node);return self.create_legend(self.map,clusters),setTimeout(()=>{self.map.invalidateSize()},200),self.map},this.add_layer_control=function(map,source_maps){if(source_maps.length>0){const baseLayers={};source_maps.forEach(layer=>{baseLayers[layer.name]=L.tileLayer(layer.url,layer.options)}),L.control.layers(baseLayers).addTo(map)}},this.add_markers=function(map,data,map_node){const clusterHallazgos=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),clusterCecas=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),clusterComplejos=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),iconoCeca=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/IMG_8276.png":"./tpl/assets/images/map/IMG_8276.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),iconoComplejo=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/IMG_5962.png":"./tpl/assets/images/map/IMG_5962.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),iconoHallazgo=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/orange.png":"./tpl/assets/images/map/orange.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});for(let index=0;index<data.hallazgos.datos.length;index++){let data_hallazgo=null;try{data_hallazgo=JSON.parse(data.hallazgos.datos[index].map)}catch(error){data_hallazgo=data.hallazgos.datos[index].map}if(null!=data_hallazgo){const markerHallazgo=L.marker([data_hallazgo.lat,data_hallazgo.lon],{icon:iconoHallazgo}).bindPopup(`<b>Hallazgo</b><br>${data.hallazgos.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasHallazgos(data.hallazgos.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.hallazgos.datos[index],monedas.result),this.openPopup()}));clusterHallazgos.addLayer(markerHallazgo)}}for(let index=0;index<data.cecas.datos.length;index++){let rawMap=data.cecas.datos[index].map,data_ceca;if("string"==typeof rawMap)try{data_ceca=JSON.parse(rawMap)}catch(e){console.error("El valor no es un JSON vÃ¡lido:",rawMap,e);continue}else data_ceca=rawMap;if(null!=data_ceca&&void 0!==data_ceca.lat&&void 0!==data_ceca.lon){const markerCeca=L.marker([data_ceca.lat,data_ceca.lon],{icon:iconoCeca}).bindPopup(`<b>Ceca</b><br>${data.cecas.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasCecas(data.cecas.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.cecas.datos[index],monedas.result),this.openPopup()}));clusterCecas.addLayer(markerCeca)}}if(null!=data.complejos.datos)for(let index=0;index<data.complejos.datos.length;index++){let data_complejos=null;try{data_complejos=JSON.parse(data.complejos.datos[index].map)}catch(error){data_complejos=data.complejos.datos[index].map}if(null!=data_complejos){const markerComplejo=L.marker([data_complejos.lat,data_complejos.lon],{icon:iconoComplejo}).bindPopup(`<b>Complejo</b><br>${data.complejos.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasComplejos(data.complejos.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.complejos.datos[index],monedas.result),this.openPopup()}));clusterComplejos.addLayer(markerComplejo)}}map.addLayer(clusterHallazgos),map.addLayer(clusterCecas),map.addLayer(clusterComplejos);const clusters={clusterHallazgos:clusterHallazgos,clusterCecas:clusterCecas,clusterComplejos:clusterComplejos};return clusters},this.create_legend=function(map,clusters){const DEV_MODE=!0;L.control.Legend({position:"bottomleft",collapsed:!1,title:"Leyenda",columns:2,legends:[{label:"Ceca",type:"image",url:this.unique?"../tpl/assets/images/map/IMG_8276.png":"./tpl/assets/images/map/IMG_8276.png",layers:clusters.clusterCecas},{label:"Hallazgo",type:"image",url:this.unique?"../tpl/assets/images/map/orange.png":"./tpl/assets/images/map/orange.png",layers:clusters.clusterHallazgos},{label:"Complejo",type:"image",url:this.unique?"../tpl/assets/images/map/IMG_5962.png":"./tpl/assets/images/map/IMG_5962.png",layers:clusters.clusterComplejos}]}).addTo(map);const drawnItems=new L.FeatureGroup;function cargarRutasCache(){const rutasCache=localStorage.getItem("rutas");if(rutasCache){console.log("RUTAS CACHE",rutasCache);const data=JSON.parse(rutasCache);L.geoJSON(data,{style:function(feature){return{color:feature.properties.color||"blue",weight:6,dashArray:"5,5"}}}).eachLayer(layer=>drawnItems.addLayer(layer))}else console.log("No hay rutas en cache aÃºn.")}map.addLayer(drawnItems),cargarRutasCache();{const drawControl=new L.Control.Draw({draw:{polyline:{shapeOptions:{color:"green",weight:2},repeatMode:!1},polygon:!1,rectangle:!1,circle:!1,marker:!1},edit:{featureGroup:drawnItems}});map.addControl(drawControl),map.on(L.Draw.Event.CREATED,(function(e){const layer=e.layer;layer.feature=layer.feature||{type:"Feature",properties:{}},layer.feature.properties.color="green",drawnItems.addLayer(layer)}));const GuardarControl=L.Control.extend({options:{position:"topleft"},onAdd:function(map){const container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");return container.style.backgroundColor="white",container.style.padding="5px",container.style.cursor="pointer",container.innerHTML="ðŸ’¾ Guardar",container.onclick=function(){const geojsonData=drawnItems.toGeoJSON();localStorage.setItem("rutas",JSON.stringify(geojsonData)),alert("Rutas guardadas en cache correctamente")},container}});map.addControl(new GuardarControl)}},this.move_map_to_point=function(location){this.map.setView([location.lat,location.lon],14)}}




function list_factory(){this.data=null,this.fn_row_builder=null,this.pagination=null,this.caller,this.init=function(e){const t=this;return t.data=e.data||[],t.fn_row_builder=e.fn_row_builder,t.pagination=void 0===e.pagination||null===e.pagination?{total:null,limit:10,offset:0,n_nodes:10}:e.pagination,t.caller=e.caller,t.status="initied",!0},this.render_list=function(){const e=this;return new Promise((function(t){const n=new DocumentFragment,o=e.data.length;let r;if(e.pagination){r=e.pagination,r.count=o,r.class_name="top";const t=e.render_pagination(r);t&&n.appendChild(t)}const i=common.create_dom_element({element_type:"div",class_name:"rows_container",parent:n});e.caller&&e.caller.view_mode&&"list_images"===e.caller.view_mode&&common.create_dom_element({element_type:"div",class_name:"grid-sizer",parent:i});for(let t=0;t<o;t++){const n=e.fn_row_builder(e.data[t],e.caller.view_mode);n&&i.appendChild(n)}e.pagination&&(r.class_name="bottom",n.appendChild(e.render_pagination(r))),t(n)}))},this.render_pagination=function(e){e.class_name;const t=common.create_dom_element({element_type:"div",class_name:"pagination"+(e.class_name?" "+e.class_name:"")}),n=this.paginator.get_full_paginator(e);n&&t.appendChild(n);common.create_dom_element({element_type:"div",class_name:"spacer",parent:t});return t.appendChild(this.paginator.get_totals_node(e)),t},this.paginator={_string:{to:tstring.to||"to",of:tstring.of||"of",first:tstring.first||"<<",prev:tstring.prev||"Prev",next:tstring.next||"Next",last:tstring.last||">>",showed:tstring.showed||"Showed"},get_full_paginator:function(e){const t=parseInt(e.total),n=parseInt(e.limit),o=parseInt(e.offset),r=e.n_nodes?parseInt(e.n_nodes):0,i=this.build_page_nodes(t,n,o,r);return this.build_paginator_html(i,!1)},build_page_nodes:function(e,t,n,o){!0===SHOW_DEBUG&&console.log("[paginator.build_page_nodes] : total",e,"limit:",t,"offset",n,"n_nodes:",o);const r=this,i=[];if(e<t)return i;o&&0!==o||(o=6),i.push({label:r._string.first,offset_value:0,type:"navigator",active:n>=t,id:"first"}),i.push({label:r._string.prev,offset_value:n-t>0?n-t:0,type:"navigator",active:n>=t,id:"previous"});const a=t>0?Math.ceil(e/t):0,s=t>0?Math.ceil(n/t)+1:1;let l=Math.ceil(o/2);if(s<=l&&(l=2*l-s+1),a>0)for(let e=1;e<=a;e++){const o=e-1==n/t,r=!o,a=(e-1)*t;(e>=s-l&&e<=s||e>=s-l&&e<=s+l)&&i.push({label:e,offset_value:a,type:"page",selected:o,active:r,id:e})}i.push({label:r._string.next,offset_value:n+t,type:"navigator",active:n<e-t,id:"next"}),i.push({label:r._string.last||">>",offset_value:(a-1)*t,type:"navigator",active:n<e-t,id:"last"});return SHOW_DEBUG,{total:e,limit:t,offset:n,nodes:o,n_pages:a,n_pages_group:l,current_page:s,ar_nodes:i}},
build_paginator_html:function(e){const t=new DocumentFragment,n=e.ar_nodes||[],o=n.length;for(let e=0;e<o;e++){const o=n[e];let r="navigator"===o.type?o.type+" "+o.id:o.type;!0===o.selected&&(r+=" selected");const i=common.create_dom_element({element_type:"a",class_name:r+(o.active?"":" unactive"),text_content:o.label,parent:t});!0===o.active&&i.addEventListener("click",(function(){event_manager.publish("paginate",o.offset_value)}))}const r=common.create_dom_element({element_type:"div",class_name:"paginator_wrapper navigator"});return r.appendChild(t),r},get_totals_node:function(e){const t=this,n=e.total,o=(e.limit,e.offset),r=e.count,i=0==n?0:Math.ceil(1*o)||1,a=o+r,s=0===n?t._string.showed+" "+n:t._string.showed+" "+i+" "+t._string.to+" "+a+" "+t._string.of+" "+n;return common.create_dom_element({element_type:"div",class_name:"totals",text_content:s})}}}function tree_factory(){this.target=null,this.data=null,this.root_term=null,this.caller,this.init=function(e){performance.now();const t=this,n=e.target||null,o=e.data,r=e.caller,i=e.root_term,a=e.set_hilite||!1,s=e.render_node||t.build_tree_node;t.target=n,t.data=o,t.caller=r,t.root_term=i,t.set_hilite=a,t.hilite_relations_limit=15,t.hilite_relations_showed=0,t.hilite_indexation_limit=15,t.hilite_indexation_showed=0,t.render_node=s;const l=sessionStorage.getItem("tree_state_"+WEB_AREA);if(l&&!t.set_hilite){t.tree_state=JSON.parse(l);for(const e in t.tree_state){const n=t.tree_state[e],o=t.data.find((t=>t.term_id===e));o&&(o.state=n)}}else{t.tree_state={};const e=t.data.length;for(let n=0;n<e;n++){const e=t.data[n];-1!==i.indexOf(e.term_id)&&(e.status="opened");const o=e.status||"closed";e.state=o,"opened"===o&&(t.tree_state[e.term_id]=o)}sessionStorage.setItem("tree_state_"+WEB_AREA,JSON.stringify(t.tree_state))}return t.status="initied",!0},this.render=function(){const e=this,t=e.target,n=e.data,o=e.root_term;return new Promise((function(t){const r=new DocumentFragment,i={},a=performance.now(),s=n.length;for(let t=0;t<s;t++){const o=n[t];if(o.descriptor&&"yes"!==o.descriptor){console.warn("Skipped build_tree_node of term ND :",o.term_id,o.term);continue}const r=e.render_node(o,e);i[o.term_id]=r}if(!0===SHOW_DEBUG){const e=performance.now()-a,t=Object.keys(i).length,n=e/t;console.log("__Time time build dom nodes ms:",e,"n_nodes:",t,"average node ms:",n)}const l=performance.now();for(const e in i){const t=i[e];if(o)if(-1!==o.indexOf(e))r.appendChild(t);else{const e=t.parent?t.parent[0]:null;if(!e){console.log("skip non parent defined tree_node:",t);continue}i[e]&&i[e].branch&&i[e].branch.appendChild(t)}else{const n=t.parent?t.parent[0]:null;n?i[n]?i[n].branch.appendChild(t):(r.appendChild(t),console.log("Direct to fragment:",e,"parent",n)):(console.warn("Added non parent defined tree_node:",t),r.appendChild(t))}}!0===SHOW_DEBUG&&console.log("__Time performance.now()-t2 hierarchize dom nodes:",performance.now()-l);const c=common.create_dom_element({element_type:"div",class_name:"tree_wrapper"});c.appendChild(r),t(c)})).then((function(n){return t&&(t.appendChild(n),!0===e.set_hilite&&common.when_in_dom(t,(function(){const e=t.querySelector(".term.hilite");e&&e.scrollIntoView({behavior:"auto",block:"center",inline:"nearest"})}))),n}))},this.build_tree_node=function(t){const n=this,o=common.create_dom_element({element_type:"div",class_name:"tree_node",id:t.term_id});o.term_id=t.term_id,o.parent=t.parent;const r=t.term,i=!0===(t.hilite&&!0===t.hilite)?" hilite":"";common.create_dom_element({element_type:"span",class_name:"term"+i,inner_html:r,parent:o});if(t.nd&&t.nd.length>0&&common.create_dom_element({element_type:"span",class_name:"nd",inner_html:"["+t.nd.join(", ")+"]",parent:o}),t.scope_note&&t.scope_note.length>0){common.create_dom_element({element_type:"span",class_name:"btn_scope_note",parent:o}).addEventListener("mousedown",(function(){this.classList.contains("open")?(l.classList.add("hide"),this.classList.remove("open")):(l.classList.remove("hide"),this.classList.add("open"))}))}let a,s,l,c,_,d;if(t.relations&&t.relations.length>0&&(a=common.create_dom_element({element_type:"span",class_name:"btn_relations",parent:o}),a.addEventListener("mousedown",(function(){this.classList.contains("open")?(c.classList.add("hide"),this.classList.remove("open")):(c.classList.remove("hide"),this.classList.add("open"))}))),t.indexation&&t.indexation.length>0&&(s=common.create_dom_element({element_type:"span",class_name:"btn_indexation",parent:o}),s.addEventListener("mousedown",(function(){this.classList.contains("open")?(_.classList.add("hide"),this.classList.remove("open")):(_.classList.remove("hide"),this.classList.add("open"))}))),t.children&&t.children.length>0){const r="opened"===t.state?" open":"";common.create_dom_element({element_type:"span",class_name:"arrow"+r,parent:o}).addEventListener("mousedown",(function(){let o;e.stopPropagation(),this.classList.contains("open")?(d.classList.add("hide"),this.classList.remove("open"),o="closed"):(d.classList.remove("hide"),this.classList.add("open"),o="opened");n.tree_state[t.term_id]!==o&&(n.tree_state[t.term_id]=o,sessionStorage.setItem("tree_state_"+WEB_AREA,JSON.stringify(n.tree_state)))}))}if(t.scope_note&&t.scope_note.length>0){t.state;const e=t.scope_note.replace(/^\s*<br\s*\/?>|<br\s*\/?>\s*$/g,"");l=common.create_dom_element({element_type:"div",class_name:"scope_note hide",inner_html:e,parent:o})}if(t.relations&&t.relations.length>0){c=common.create_dom_element({element_type:"div",class_name:"relations_container hide",parent:o});const e=function(e,o){for(let r of e)"attributes"===r.type&&"class"===r.attributeName&&(e[0].target.classList.contains("hide")||(n.render_relation_nodes(t,c,n,!1),o.disconnect()))};new MutationObserver(e).observe(c,{attributes:!0,childList:!1,subtree:!1}),!0===t.hilite&&n.hilite_relations_showed<n.hilite_relations_limit&&(c.classList.remove("hide"),a.classList.add("open"),n.hilite_relations_showed++)}if(t.indexation&&t.indexation.length>0){_=common.create_dom_element({element_type:"div",class_name:"indexation_container hide",parent:o});const e=function(e,o){for(let r of e)"attributes"===r.type&&"class"===r.attributeName&&(e[0].target.classList.contains("hide")||(n.render_indexation_nodes(t,_,n),o.disconnect()))};new MutationObserver(e).observe(_,{attributes:!0,childList:!1,subtree:!1}),!0===t.hilite&&n.hilite_indexation_showed<n.hilite_indexation_limit&&(_.classList.remove("hide"),s.classList.add("open"),n.hilite_indexation_showed++)}if(t.children&&t.children.length>0){const e="opened"===t.state?"":" hide";d=common.create_dom_element({element_type:"div",class_name:"branch"+e,parent:o}),o.branch=d}else o.branch=null;return o},this.render_relation_nodes=function(e,t,n,o,r){return new Promise((function(i){e||(console.warn("Invalid row: ",e),console.trace(),i(!1)),(!e.relations||e.relations.length<1)&&i(!1),r=isNaN(r)?100:r;let a=0;const s=e.relations.length;!function l(c,_){const d=new DocumentFragment,u=[];for(let t=c;t<_;t++)u.push(n.build_relation_item({data:e.relations[t]}));Promise.all(u).then((n=>{for(let e=0;e<n.length;e++){const t=n[e];d.appendChild(t)}if(!0===o){const n=t.querySelector(".view_in_context")||common.create_dom_element({element_type:"a",href:page_globals.__WEB_ROOT_WEB__+"/thesaurus/"+e.term_id,class_name:"relation_item view_in_context",target:"_blank",title:"Thesaurus "+e.term});d.appendChild(n)}if(_<s-1){a+=_-c;const e=common.create_dom_element({element_type:"div",class_name:"more_node btn btn-light btn-block primary relation_item",parent:d});e.offset=_,e.addEventListener("click",(function(){const e=this.offset+1;l(e,e+r<s?e+r:s),this.remove()}));const t=(tstring.load_more||"Load more..")+" <small>["+a+" "+tstring.of+" "+s+"]</small>";common.create_dom_element({element_type:"span",inner_html:t,parent:e})}t.appendChild(d),i(!0)}))}(0,r<s?r:s)}))},this.build_relation_item=function(e){const t=e.data;return new Promise((function(n){t.image_url;const o=t.thumb_url,r=t.title,i=t.path||t.table,a=r||"",s=common.create_dom_element({element_type:"div",class_name:"relation_item",title:a+(SHOW_DEBUG?" ["+i+" "+e.data.section_tipo+" "+e.data.section_id+"]":"")});page.build_image_with_background_color(o,s).then((function(e){const n=e.img;s.appendChild(n),n.addEventListener("mousedown",(function(){const e=page_globals.__WEB_ROOT_WEB__+"/"+i+"/"+t.section_id;window.open(e).focus()}))})),n(s)}))},this.render_indexation_nodes=function(e,t,n){return!0===SHOW_DEBUG&&console.log("-- render_indexation_nodes row:",e),new Promise((function(o){(!e.indexation||e.indexation.length<1)&&o(!1),n.caller.get_indexation_data(e.indexation).then((function(r){const i=r.data_indexation,a=r.data_interview,s=i.reduce((function(e,t){const n=t.index_locator.section_top_id;return e[n]=e[n]||[],e[n].push(t),e}),Object.create(null));for(const o in s){const r=s[o];n.build_indexation_item({data_video_items:r,data_interview:a,term:e.term,parent:t})}o(!0)}))}))},this.build_indexation_item=function(e){console.warn("-- build_indexation_item options:",e);return new Promise((function(t){const n=e.parent,o=e.data_video_items,r=e.data_interview,i=e.term,a=o[0].section_id,s=common.create_dom_element({element_type:"div",class_name:"indexation_item",parent:n}),l=a?common.get_media_engine_url(a,"posterframe","thumb",!0):__WEB_TEMPLATE_WEB__+"/assets/images/default_thumb.jpg";page.build_image_with_background_color(l,s,null).then((function(e){const n=e.img;s.appendChild(n);n.addEventListener("click",(function(){event_manager.publish("open_video",{mode:"indexation",data_interview:r,data_video_items:o,term:i,selected_key:0})})),t(n)}))}))},this.get_thesaurus_children=function(e){return new Promise((function(t){const n=e.join(",");data_manager.request({body:{dedalo_get:"thesaurus_children",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,ar_fields:["term_id"],term_id:n,recursive:!0,only_descriptors:!0,remove_restricted:!1,multiple:!0}}).then((function(e){const n=[],o=e.result;for(let e=0;e<o.length;e++){const t=o[e].result;for(let e=0;e<t.length;e++)n.push(t[e])}t(n.map((function(e){return e.term_id})))}))}))}}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e)+e)}!function(){const e=function(){};e.prototype.request=async function(e){let t=e.url||null;const n=e.method||"POST",o=e.mode||"cors",r=e.cache||"no-cache",i=e.credentials||"same-origin",a=e.headers||{"Content-Type":"application/json"},s=e.redirect||"follow",l=e.referrer||"no-referrer",c=e.body,_=void 0!==window.page_globals?window.page_globals:null;!t&&_&&(t=_.JSON_TRIGGER_URL),!c.code&&_&&(c.code=_.API_WEB_USER_CODE),!c.lang&&_&&(c.lang=_.WEB_CURRENT_LANG_CODE),!c.db_name&&_&&_.WEB_DB&&(c.db_name=_.WEB_DB);return fetch(t,{method:n,mode:o,cache:r,credentials:i,headers:a,redirect:s,referrer:l,body:JSON.stringify(c)}).then((function(e){if(!e.ok)throw console.warn("-> handle_errors response:",e),Error(e.statusText);return e})).then((e=>e.json().then((e=>e)))).catch((e=>(console.error("!!!!! [page data_manager.request] ERROR:",e),{result:!1,msg:e.message,error:e})))};window.data_manager=new e,window.event_manager=new function(){this.events=[],this.last_token=-1,this.subscribe=function(e,t){const n="event_"+String(++this.last_token),o={event_name:e,token:n,callback:t};return this.events.push(o),n},this.unsubscribe=function(e){return this.events.map(((t,n,o)=>{t.token===e&&o.splice(n,1)}))},this.publish=function(e,t={}){const n=this.events.filter((t=>t.event_name===e));if(n){return n.map((e=>e.callback(t)))}return!1},this.get_events=function(){return this.events},this.fire_event=function(e,t){var n;if(e.ownerDocument)n=e.ownerDocument;else{if(9!=e.nodeType)throw new Error("Invalid node passed to fireEvent: "+e.id);n=e}if(e.dispatchEvent){var o="";switch(t){case"click":case"mousedown":case"mouseup":o="MouseEvents";break;case"focus":case"change":case"blur":case"select":o="HTMLEvents";break;default:throw"fireEvent: Couldn't find an event class for event '"+t+"'."}var r="change"!=t;(i=n.createEvent(o)).initEvent(t,r,!0),i.synthetic=!0,e.dispatchEvent(i,!0)}else if(e.fireEvent){var i;(i=n.createEventObject()).synthetic=!0,e.fireEvent("on"+t,i)}},this.when_in_dom=function(e,t){const n=new MutationObserver((function(o){document.contains(e)&&(n.disconnect(),t(this))}));return n.observe(document,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),n}}}();