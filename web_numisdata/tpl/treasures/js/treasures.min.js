"use strict";var treasures={search_options:{},form:null,pagination:null,list:null,form_node:null,form_container:null,rows_container:null,set_up:function(options){const self=this;self.form_container=options.form_container,self.rows_container=options.rows_container;const psqo=options.psqo;self.form=new form_factory;const form_node=self.render_form();function paginate(offset){self.pagination.offset=offset,self.form_submit()}if(self.form_container.appendChild(form_node),self.pagination={total:null,limit:10,offset:0,n_nodes:8},event_manager.subscribe("paginate",paginate),psqo&&psqo.length>1){const decoded_psqo=psqo_factory.decode_psqo(psqo);decoded_psqo&&(self.form.parse_psqo_to_form(decoded_psqo),self.form_submit(form_node,{scroll_result:!0}))}else self.pagination={total:null,limit:10,offset:0,n_nodes:8},self.form_submit();return!0},render_form:function(){const self=this,fragment=new DocumentFragment,form_row=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:fragment});self.form.item_factory({id:"name",name:"name",label:"Nombre",q_column:"name",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"hoards"})}}),self.form.item_factory({id:"place",name:"place",label:"Lugar",q_column:"place",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"hoards"})}});const submit_group=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:fragment}),submit_button=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:submit_group});submit_button.addEventListener("click",(function(e){e.preventDefault(),self.pagination={total:null,offset:0},self.form_submit()}));const operators_node=self.form.build_operators_node();return fragment.appendChild(operators_node),self.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),self.form.node.appendChild(fragment),self.form.node},form_submit:function(){const self=this,form_node=self.form.node;if(!form_node)return new Promise((function(resolve){console.error("Error on submit. Invalid form_node.",form_node),resolve(!1)}));const rows_container=self.rows_container;return self.pagination.total?rows_container.classList.add("loading"):page.add_spinner(rows_container),new Promise((function(resolve){const table="hoards",ar_fields=["*"],limit=self.pagination.limit||0,offset=self.pagination.offset||0,count=!0,order="name",filter=self.form.build_filter(),group=[],parsed_filter=self.form.parse_sql_filter(filter,group,!0),base_filter="(name != '' AND map != '')";let final_filter=base_filter;const sql_filter=parsed_filter?"("+parsed_filter+")":null;!0===SHOW_DEBUG&&console.log("-> coins form_submit sql_filter:",sql_filter),sql_filter&&(final_filter=base_filter+" AND "+sql_filter),SHOW_DEBUG;const body={dedalo_get:"records",table:table,ar_fields:ar_fields,sql_filter:final_filter,limit:limit,count:!0,offset:offset,order:order,process_result:null};data_manager.request({body:body}).then((function(api_response){const data=page.parse_hoard_data(api_response.result),total=api_response.total;self.pagination.total=total,self.pagination.offset=offset,data||(rows_container.classList.remove("loading"),resolve(null)),function(){for(;rows_container.hasChildNodes();)rows_container.removeChild(rows_container.lastChild);rows_container.classList.remove("loading")}(),self.list=self.list||new list_factory,self.list.init({data:data,fn_row_builder:self.list_row_builder,pagination:self.pagination,caller:self}),self.list.render_list().then((function(list_node){list_node&&rows_container.appendChild(list_node),resolve(list_node)}));const ar_id_promise=0===limit&&0===offset?Promise.resolve(data.map(el=>el.section_id)):(()=>{const new_body=Object.assign({},body);return new_body.limit=0,new_body.offset=0,new_body.count=!1,new_body.ar_fields=["section_id"],data_manager.request({body:new_body}).then((function(response){const ar_id=response.result?response.result.map(el=>el.section_id):null;return ar_id}))})();ar_id_promise.then((function(){}))}));const div_result=document.querySelector(".rows_container");div_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}))},list_row_builder:function(data){return treasures_rows.draw_item(data)}};