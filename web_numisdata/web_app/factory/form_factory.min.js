"use strict";function form_factory(){this.form_items=[],this.node=null,this.operators_node=null,this.group=[],this.item_factory=function(options){const self=this,form_item=self.build_form_item(options);return options.parent&&self.build_form_node(form_item,options.parent),"function"==typeof options.callback&&options.callback(form_item),self.form_items[options.id]=form_item,form_item},this.build_form_item=function(options){const form_item={id:options.name,name:options.name,label:options.label,class_name:options.class_name||null,q:options.q||"",q_selected:[],q_selected_eq:options.q_selected_eq||"=",q_column:options.q_column,q_column_filter:options.q_column_filter,q_column_group:options.q_column_group,q_splittable:options.q_splittable||!1,sql_filter:options.sql_filter||null,eq:options.eq||"LIKE",eq_in:void 0!==options.eq_in?options.eq_in:"",eq_out:void 0!==options.eq_out?options.eq_out:"%",is_term:options.is_term||!1,callback:options.callback||!1,list_format:options.list_format||null,wrapper:options.wrapper||null,value_wrapper:options.value_wrapper||null,value_split:options.value_split||null,node_input:null,node_values:null,input_type:options.input_type,input_values:options.input_values,group_op:options.group_op||"$and"};return form_item},this.build_form_node=function(form_item,parent){const group=common.create_dom_element({element_type:"div",class_name:"form-group field "+(form_item.class_name||""),title:form_item.is_term?form_item.label+" (is_term)":form_item.label,parent:parent});switch(form_item.input_type){case"range_slider":const range_slider_labels=common.create_dom_element({element_type:"div",class_name:"range_slider_labels",parent:group}),range_slider_value_in=common.create_dom_element({element_type:"input",type:"text",id:form_item.id+"_in",class_name:"form-control range_slider_value value_in",parent:range_slider_labels}),node_label=common.create_dom_element({element_type:"span",class_name:"form-control range_slider_label node_label",inner_html:form_item.label,parent:range_slider_labels}),range_slider_value_out=common.create_dom_element({element_type:"input",type:"text",id:form_item.id+"_out",class_name:"form-control range_slider_value value_out",parent:range_slider_labels}),node_slider=common.create_dom_element({element_type:"div",id:form_item.id,class_name:"form-control "+(form_item.class_name?" "+form_item.class_name:""),parent:group});form_item.node_input=node_slider;break;case"select":const node_select=common.create_dom_element({element_type:"select",id:form_item.id,class_name:"form-control ui-autocomplete-select"+(form_item.class_name?" "+form_item.class_name:""),value:form_item.q||"",parent:group});for(let i=0;i<form_item.input_values.length;i++)form_item.input_values[i],common.create_dom_element({element_type:"option",value:form_item.input_values[i].value,inner_html:form_item.input_values[i].label,parent:node_select});node_select.addEventListener("change",(function(e){console.log("e.target.value:",e.target.value),e.target.value&&(form_item.q=e.target.value,console.log("form_item:",form_item))})),form_item.node_input=node_select;break;default:let label_node;const node_input=common.create_dom_element({element_type:"input",type:"text",id:form_item.id,class_name:"form-control ui-autocomplete-input"+(form_item.class_name?" "+form_item.class_name:""),placeholder:form_item.label,value:form_item.q||"",parent:group});node_input.addEventListener("keyup",(function(e){form_item.q=e.target.value,node_input.value.length>0?label_node=label_node||common.create_dom_element({element_type:"span",class_name:"form_input_label",inner_html:form_item.label,parent:group}):label_node&&(label_node.remove(),label_node=null)})),node_input.addEventListener("blur",(function(e){label_node&&0===node_input.value.length&&(label_node.remove(),label_node=null)})),form_item.node_input=node_input}const node_values=common.create_dom_element({element_type:"div",class_name:"container_values",parent:group});return form_item.node_values=node_values,!0},this.build_operators_node=function(){const self=this,group=common.create_dom_element({element_type:"div",class_name:"form-group field field_operators"}),operator_label=common.create_dom_element({element_type:"span",class_name:"radio operators",text_content:tstring.operator||"Operator",parent:group}),radio1=common.create_dom_element({element_type:"input",type:"radio",id:"operator_or",parent:group});radio1.setAttribute("name","operators"),radio1.setAttribute("value","$or");const radio1_label=common.create_dom_element({element_type:"label",text_content:tstring.or||"or",parent:group});radio1_label.setAttribute("for","operator_or");const radio2=common.create_dom_element({element_type:"input",type:"radio",id:"operator_and",name:"operators",parent:group});radio2.setAttribute("name","operators"),radio2.setAttribute("value","$and"),radio2.setAttribute("checked","checked");const radio2_label=common.create_dom_element({element_type:"label",text_content:tstring.and||"and",parent:group});return radio2_label.setAttribute("for","operator_and"),this.operators_node=group,group},this.set_operator_node_value=function(operator_value){const self=this,operator="$and"===operator_value?"and":"$or"===operator_value?"or":null;if(!operator)return!1;const radio_button=this.operators_node.querySelector("#operator_"+operator);return radio_button.setAttribute("checked","checked"),!0},this.add_selected_value=function(form_item,label,value){const container=form_item.node_values,inputs=container.querySelectorAll(".input_values"),inputs_length=inputs.length;for(let i=inputs_length-1;i>=0;i--)if(value===inputs[i].value)return!1;const line=common.create_dom_element({element_type:"div",class_name:"line_value",parent:container}),trash=common.create_dom_element({element_type:"i",class_name:"icon remove fal far fa-trash fa-trash-alt",parent:line});trash.addEventListener("click",(function(){const index=form_item.q_selected.indexOf(value);index>-1&&(form_item.q_selected.splice(index,1),this.parentNode.remove(),!0===SHOW_DEBUG&&console.log("form_item.q_selected removed value:",value,form_item.q_selected))}));const value_label=common.create_dom_element({element_type:"span",class_name:"value_label",inner_html:label,parent:line}),input=common.create_dom_element({element_type:"input",class_name:"input_values",parent:line});return input.value=value,form_item.q_selected.push(value),form_item.node_input.value="",form_item.q="",!0},this.set_input_value=function(form_item,value){return form_item.node_input.value=value,form_item.q=value,!0},this.set_form_item=function(psqo_item){const self=this,q_column=psqo_item.id,form_item=self.form_items[q_column];if(!form_item)return console.error("Error on get form item",psqo_item,self.form_items),!1;form_item.op=psqo_item.op||form_item.op,form_item.eq_in=psqo_item.eq_in||form_item.eq_in,form_item.eq_out=psqo_item.eq_out||form_item.eq_out;const clean_value=psqo_item.q;if("q_selected"===psqo_item.q_type){const label=clean_value;self.add_selected_value(form_item,label,clean_value)}else self.set_input_value(form_item,clean_value);return form_item},this.build_filter=function(options={}){const self=this,form_items=options.form_items||this.form_items,ar_query_elements=[];for(let[id,form_item]of Object.entries(form_items)){const group_op=!0===form_item.is_term?"$or":form_item.group_op?form_item.group_op:"$and",group={};if(group[group_op]=[],0!==form_item.q.length&&"*"!==form_item.q||form_item.sql_filter){if("range_slider"===form_item.input_type&&(!form_item.sql_filter||form_item.sql_filter.length<2))continue;const c_group_op="$and",c_group={};c_group[c_group_op]=[];const safe_value="string"==typeof form_item.q||form_item.q instanceof String?form_item.q.replace(/(')/g,"''"):form_item.q,element={id:form_item.id,field:form_item.q_column,value:`'${form_item.eq_in}${safe_value}${form_item.eq_out}'`,op:form_item.eq,q_type:"q",q:form_item.q};form_item.sql_filter&&(element.sql_filter=form_item.sql_filter),form_item.wrapper&&(element.wrapper=form_item.wrapper),c_group[c_group_op].push(element),group[group_op].push(c_group)}if(0!==form_item.q_selected.length)for(let j=0;j<form_item.q_selected.length;j++){const value=form_item.q_selected[j],safe_value="string"==typeof value||value instanceof String?value.replace(/(')/g,"''"):value,item_value=form_item.value_wrapper&&form_item.value_wrapper.length>1?form_item.value_wrapper[0]+safe_value+form_item.value_wrapper[1]:safe_value,c_group_op="$and",c_group={};c_group[c_group_op]=[];const element={id:form_item.id,field:form_item.q_column,value:"LIKE"===form_item.q_selected_eq?`'%${item_value}%'`:`'${item_value}'`,op:form_item.q_selected_eq,q_type:"q_selected",q:value};form_item.sql_filter&&(element.sql_filter=form_item.sql_filter),form_item.wrapper&&(element.wrapper=form_item.wrapper),c_group[c_group_op].push(element),group[group_op].push(c_group)}group[group_op].length>0&&ar_query_elements.push(group)}if(SHOW_DEBUG,ar_query_elements.length<1)return console.warn("-> form_to_sql_filter empty elements selected:",ar_query_elements),!1;const input_operators=this.operators_node?this.operators_node.querySelector('input[name="operators"]'):null,operators_value=input_operators?this.operators_node.querySelector('input[name="operators"]:checked').value:"$and",filter={};return filter[operators_value]=ar_query_elements,filter},this.parse_sql_filter=function(filter,group,recursive,global_search){const self=this,sql_filter=filter?function(){const op=Object.keys(filter)[0],ar_query=filter[op],ar_filter=[],ar_query_length=ar_query.length;for(let i=0;i<ar_query_length;i++){const item=ar_query[i],item_op=Object.keys(item)[0];if("$and"===item_op||"$or"===item_op){if(recursive){const current_filter_line=""+self.parse_sql_filter(item,group,recursive);ar_filter.push(current_filter_line)}continue}const item_field=item.wrapper&&item.wrapper.length>0?item.wrapper+"("+item.field+")":item.field;let filter_line;filter_line=item.sql_filter&&item.sql_filter.length>0?item.sql_filter:"MATCH"===item.op?"MATCH ("+item_field+") AGAINST ("+item.value+" IN BOOLEAN MODE)":-1!==item_field.indexOf("AS")||-1!==item_field.indexOf("CONCAT")||item.wrapper&&item.wrapper.length>0?"("+item_field+" "+item.op+" "+item.value+" AND "+item_field+"!='')":"(`"+item_field+"` "+item.op+" "+item.value+" AND `"+item_field+"`!='')","term"==item_field&&(filter_line+=" AND term_section_label LIKE '%Grupo numismático%' AND parent LIKE  '[\"21057\"]'"),global_search&&(filter_line+=` OR parents_text LIKE ${item.value}`),ar_filter.push(filter_line),group&&item.group&&group.push(item.group)}const boolean_op="$and"===op?"AND":"$or"===op?"OR":null;return ar_filter.join(" "+boolean_op+" ")}():null;return sql_filter},this.parse_psqo_to_form=function(psqo,recursion){const self=this,global_key=Object.keys(psqo)[0];if("$and"===global_key||"$or"===global_key){recursion||self.set_operator_node_value(global_key);for(let i=0;i<psqo[global_key].length;i++)self.parse_psqo_to_form(psqo[global_key][i],!0)}else self.set_form_item(psqo);return!0},this.full_text_search_operators_info=function(){const grid=common.create_dom_element({element_type:"div",class_name:"full_text_search_operators_info"}),pairs=[{op:tstring.operator,info:tstring.description},{op:"+",info:tstring.include_the_word||"Include, the word must be present."},{op:"-",info:tstring.exclude_the_word||"Exclude, the word must not be present."},{op:">",info:tstring.increase_ranking||"Include, and increase ranking value."},{op:"<",info:tstring.decrease_ranking||"Include, and decrease the ranking value."},{op:"()",info:tstring.group_words||"Group words into subexpressions (allowing them to be included, excluded, ranked, and so forth as a group)."},{op:"~",info:tstring.negate_word||"Negate a word’s ranking value."},{op:"*",info:tstring.wildcard_at_end||"Wildcard at the end of the word."},{op:"“”",info:tstring.defines_phrase||"Defines a phrase (as opposed to a list of individual words, the entire phrase is matched for inclusion or exclusion)."}];for(let i=0;i<pairs.length;i++)common.create_dom_element({element_type:"div",class_name:"op",text_content:pairs[i].op,parent:grid}),common.create_dom_element({element_type:"div",class_name:"info",text_content:pairs[i].info,parent:grid});return grid},this.activate_autocomplete=function(options){const self=this,form_item=options.form_item,id=options.id||!1,label=options.label||"",limit=options.limit||30,table=options.table||form_item.table,cross_filter=options.cross_filter||!0,order=options.order||"name ASC",parent_in=options.parent_in||!1,global_search=options.global_search||!1,activate_filter=0!=options.activate_filter;console.log(options.activate_filter);const parse_result=options.parse_result||function(ar_result,term){return ar_result.map((function(item){return item.label=item.label.replace(/<br>/g," "),"function"==typeof page.parse_legend_svg&&(item.label=page.parse_legend_svg(item.label)),item}))};!function($){var proto=$.ui.autocomplete.prototype,initSource=proto._initSource;function filter(array,term){var matcher=new RegExp($.ui.autocomplete.escapeRegex(term),"i");return $.grep(array,(function(value){return matcher.test($("<div>").html(value.label||value.value||value).text())}))}$.extend(proto,{_initSource:function(){this.options.html&&$.isArray(this.options.source)?this.source=function(request,response){response(filter(this.options.source,request.term))}:initSource.call(this)},_renderItem:function(ul,item){for(var final_label=item.label,ar_parts=final_label.split(" | "),ar_clean=[],i=0;i<ar_parts.length;i++){var current=ar_parts[i];current.length>1&&"<i>.</i>"!==current&&ar_clean.push(current)}return final_label=ar_clean.join(" | "),$('<li class="ui-menu-item"></li>').data("item.autocomplete",item).append($('<div class="ui-menu-item-wrapper"></div>')[this.options.html?"html":"text"](final_label)).appendTo(ul)}})}(jQuery);const cache={};return $(form_item.node_input).autocomplete({delay:150,minLength:0,html:!0,source:async function(request,response){const term=request.term,field=form_item.q_name,q_column=form_item.q_column,q_column_group=form_item.q_column_group||q_column,op="$and",filter={$and:[]},value_parsed=form_item.eq_in+term+form_item.eq_out,safe_value="string"==typeof value_parsed||value_parsed instanceof String?value_parsed.replace(/(')/g,"''"):value_parsed;if(filter[op].push({field:form_item.q_column_filter||q_column,value:`'${safe_value}'`,op:form_item.eq,group:q_column_group}),cross_filter){const c_op="$and",c_filter={};c_filter[c_op]=[];for(let[id,current_form_item]of Object.entries(self.form_items))if(current_form_item.id!==form_item.id){if(0!==current_form_item.q.length&&"*"!==current_form_item.q||current_form_item.sql_filter){const element={field:current_form_item.q_column,value:`'%${current_form_item.q}%'`,op:"LIKE",sql_filter:current_form_item.sql_filter,wrapper:current_form_item.wrapper};c_filter[c_op].push(element)}if(0!==current_form_item.q_selected.length)for(let k=0;k<current_form_item.q_selected.length;k++){const value=current_form_item.q_selected[k],safe_value="string"==typeof value||value instanceof String?value.replace(/(')/g,"''"):value,element={field:current_form_item.q_column,value:!0===current_form_item.is_term?`'%"${safe_value}"%'`:`'${safe_value}'`,op:!0===current_form_item.is_term?"LIKE":"=",sql_filter:current_form_item.sql_filter,wrapper:current_form_item.wrapper};c_filter[c_op].push(element)}}c_filter[c_op].length>0&&filter[op].push(c_filter)}if(1===filter[op].length&&term in cache)return SHOW_DEBUG,void response(cache[term]);const sql_filter=self.parse_sql_filter(filter,self.group,activate_filter,global_search),table_resolved="function"==typeof table?table():table,field_beats=q_column.split(" AS "),plain_field=field_beats[0];let section_id="";id&&await data_manager.request({body:{dedalo_get:"records",table:table_resolved,ar_fields:[plain_field+" AS name","section_id"],sql_filter:id?" `term` LIKE '%"+label+"%'":sql_filter,group:plain_field,limit:limit,order:order}}).then(api_response=>{section_id=api_response.result[0].section_id}),await data_manager.request({body:{dedalo_get:"records",table:table_resolved,ar_fields:[plain_field+" AS name","findspots"==table_resolved||"catalog"==table_resolved?"parents_text":"section_id"],sql_filter:id?`parent LIKE  '["${section_id}"]'`:sql_filter,group:plain_field,limit:limit,order:order}}).then(async api_response=>{console.log("--\x3eautocomplete api_response:",api_response);const ar_result=[];let set_creators=new Set;const set_material=new Set,result=api_response.result,len=api_response.result.length;for(let i=0;i<len;i++){const item=api_response.result[i];if(!item.name||item.name.length<1)continue;let base_value=[];if(0===item.name.indexOf('["')&&-1!==item.name.indexOf("] | [")){const beats=item.name.split(" | "),parsed_beats=beats.map(el=>JSON.parse(el));let ar_final=[];for(let k=0;k<parsed_beats.length;k++)ar_final.concat(parsed_beats[k]);base_value=JSON.stringify(ar_final)}else base_value=item.name;const current_ar_value=0===base_value.indexOf('["')?JSON.parse(base_value):Array.isArray(base_value)?base_value:[base_value];for(let j=0;j<current_ar_value.length;j++){const item_name=current_ar_value[j],item_value=current_ar_value[j];if(item_name&&"[]"!==item_name)if(form_item.value_split){const terms=item_name.split(form_item.value_split);for(let k=0;k<terms.length;k++){const term_name=terms[k].trim(),term_name_lowercase=term_name.toLowerCase(),search_name_lowercase=request.term.toLowerCase();if(-1===term_name_lowercase.indexOf(search_name_lowercase))continue;const found=ar_result.find(el=>el.value===term_name);!found&&term_name.length>0&&!set_creators.has(term_name.split(",")[0].trim())&&(set_creators.add(term_name.split(",")[0].trim()),ar_result.push({label:term_name.split(",")[0].trim(),value:term_name.split(",")[0].trim()}))}}else{const found=ar_result.find(el=>el.value===item_name);let camino_hallazgo=" | ";if("findspots"===table_resolved){const camino_hallazgo_json=JSON.parse(item.parents_text);if(camino_hallazgo_json)for(let index=0;index<camino_hallazgo_json.length-1;index++)camino_hallazgo+=camino_hallazgo_json[index]+(index==camino_hallazgo_json.length-2?"":" | ")}if("catalog"===table_resolved&&"ref_type_material"===q_column){let name;!item_name.toLowerCase().includes("ae")&&set_material.add(item_name)}"ref_type_material"===q_column?!found&&item_value.trim().length>0&&set_material.has(item_name)&&ar_result.push({label:parent_in?item_name+camino_hallazgo:item_name,value:item_value}):!found&&item_value.trim().length>0&&ar_result.push({label:parent_in?item_name+camino_hallazgo:item_name,value:item_value})}}}const ar_result_final=parse_result(ar_result,term);1===filter[op].length&&"function"!=typeof table&&(cache[term]=ar_result_final),SHOW_DEBUG,response(ar_result_final)})},select:function(event,ui){return event.preventDefault(),self.add_selected_value(form_item,ui.item.label,ui.item.value),this.value="",!1},focus:function(){return!1},close:function(event,ui){},change:function(event,ui){},response:function(event,ui){}}).on("keydown",(function(event){event.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})),!0},this.form_to_sql_filter=function(options){console.error("WARNING! form_to_sql_filter is DEPRECATED! Use build_filter instead!");const self=this,form_node=options.form_node,form_items=this.form_items,ar_query_elements=[];for(let[id,form_item]of Object.entries(form_items)){const current_group=[],group_op="AND",group={};if(group[group_op]=[],0!==form_item.q.length){const c_group_op="AND",c_group={};c_group[c_group_op]=[];const safe_value=form_item.q.replace(/(')/g,"''"),value_parsed=form_item.eq_in+safe_value+form_item.eq_out,element={field:form_item.q_column,value:value_parsed,op:form_item.eq};c_group[c_group_op].push(element),group[group_op].push(c_group)}if(0!==form_item.q_selected.length)for(let j=0;j<form_item.q_selected.length;j++){const value=form_item.q_selected[j],safe_value=value.replace(/(')/g,"''"),c_group_op="AND",c_group={};c_group[c_group_op]=[];const element={field:form_item.q_column,value:!0===form_item.is_term?`'%"${safe_value}"%'`:`'${safe_value}'`,op:!0===form_item.is_term?"LIKE":"="};c_group[c_group_op].push(element),group[group_op].push(c_group)}group[group_op].length>0&&ar_query_elements.push(group)}if(SHOW_DEBUG,ar_query_elements.length<1)return console.warn("-> form_to_sql_filter empty elements selected:",ar_query_elements),null;const input_operators=form_node.querySelector('input[name="operators"]'),operators_value=input_operators?form_node.querySelector('input[name="operators"]:checked').value:"AND",filter={};filter[operators_value]=ar_query_elements,SHOW_DEBUG;const sql_filter=this.parse_sql_filter(filter,void 0,!0);return sql_filter}}var psqo_factory={build_safe_psqo:function(psqo){const self=this,global_key=Object.keys(psqo)[0];if("$and"!==global_key&&"$or"!==global_key)return clean_psqo_item(psqo);for(let i=0;i<psqo[global_key].length;i++)psqo[global_key][i]=self.build_safe_psqo(psqo[global_key][i]);function clean_psqo_item(psqo_item){const id=psqo_item.id,field=psqo_item.field,q=psqo_item.q,q_type=void 0!==psqo_item.q_type?psqo_item.q_type:"q",new_psqo_item={id:id,field:field,q:q,q_type:q_type};return psqo_item.op&&(new_psqo_item.op=psqo_item.op),psqo_item.eq_in&&(new_psqo_item.eq_in=psqo_item.eq_in),psqo_item.eq_out&&(new_psqo_item.eq_out=psqo_item.eq_out),new_psqo_item}return psqo},encode_psqo:function(psqo){const base=JSON.stringify(psqo);return LZString.compressToEncodedURIComponent(base)},decode_psqo:function(psqo){const parsed_psqo=(()=>{try{const base=LZString.decompressFromEncodedURIComponent(psqo);return JSON.parse(base)}catch(error){console.log("psqo:",psqo),console.warn("invalid psqo: ",error)}return null})();return parsed_psqo}};