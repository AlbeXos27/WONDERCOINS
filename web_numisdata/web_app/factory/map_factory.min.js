"use strict";function map_factory(){this.map_container=[],this.map_position=null,this.source_maps=[],this.map=null,this.map_node=null,this.result=null,this.findspot=!1,this.unique=!1,this.zoom=8,this.DEV_MODE=!1,this.obtain_location=function(georef){for(let index=0;index<georef.layer_data.length;index++){if("Point"==georef.layer_data[index].type)return[georef.layer_data[index].lat,georef.layer_data[index].lon,"Point"];{let lat=0,lon=0;for(let j=0;j<georef.layer_data[index].lon.length;j++)lon+=georef.layer_data[index].lon[j][0],lat+=georef.layer_data[index].lon[j][1];return[lat/georef.layer_data[index].lon.length,lon/georef.layer_data[index].lon.length,"Polygon"]}}},this.init=function(options){const self=this;self.map_node=options.map_node||null,self.map_container=options.map_container||null,self.map_position=options.map_position||[36.5297,-6.2924],self.popup_options=options.popup_options||{},self.source_maps=options.source_maps||[],self.result=options.result||null,self.findspot=options.findspot||!1,self.unique=options.unique||!1,self.zoom=options.zoom||8,self.DEV_MODE=options.DEV_MODE||!1;const containerElement="string"==typeof self.map_container?document.getElementById(self.map_container):self.map_container;if(!containerElement)return void console.error("Contenedor del mapa no vÃ¡lido.");self.map=L.map(containerElement,{preferCanvas:!0}).setView(self.map_position,self.zoom),self.add_layer_control(self.map,self.source_maps),self.findspot?(L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(self.map),L.tileLayer("https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png").addTo(self.map)):(L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{}).addTo(self.map),L.tileLayer("https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png",{}).addTo(self.map));const clusters=self.add_markers(self.map,self.result,self.map_node);return self.create_legend(self.map,clusters),setTimeout(()=>{self.map.invalidateSize()},200),self.map},this.add_layer_control=function(map,source_maps){if(source_maps.length>0){const baseLayers={};source_maps.forEach(layer=>{baseLayers[layer.name]=L.tileLayer(layer.url,layer.options)}),L.control.layers(baseLayers).addTo(map)}},this.add_markers=function(map,data,map_node){const clusterHallazgos=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),clusterCecas=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),clusterComplejos=L.markerClusterGroup({iconCreateFunction:function(cluster){return L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:"marker-cluster",iconSize:[40,40]})}}),iconoCeca=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/IMG_8276.png":"./tpl/assets/images/map/IMG_8276.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),iconoComplejo=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/IMG_5962.png":"./tpl/assets/images/map/IMG_5962.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]}),iconoHallazgo=L.icon({iconUrl:this.unique?"../tpl/assets/images/map/orange.png":"./tpl/assets/images/map/orange.png",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});for(let index=0;index<data.hallazgos.datos.length;index++){let data_hallazgo={lat:"",lon:""};const georef_hallazgo=JSON.parse(data.hallazgos.datos[index].georef);if(georef_hallazgo){const location=this.obtain_location(georef_hallazgo[0]);data_hallazgo.lat=location[0],data_hallazgo.lon=location[1]}else try{data_hallazgo=JSON.parse(data.hallazgos.datos[index].map)}catch(error){data_hallazgo=data.hallazgos.datos[index].map}if(null!=data_hallazgo){const markerHallazgo=L.marker([data_hallazgo.lat,data_hallazgo.lon],{icon:iconoHallazgo}).bindPopup(`<b>Hallazgo</b><br>${data.hallazgos.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasHallazgos(data.hallazgos.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.hallazgos.datos[index],monedas.result),this.openPopup()}));clusterHallazgos.addLayer(markerHallazgo)}}for(let index=0;index<data.cecas.datos.length;index++){let rawMap=data.cecas.datos[index].map,data_ceca;if("string"==typeof rawMap)try{data_ceca=JSON.parse(rawMap)}catch(e){console.error("El valor no es un JSON vÃ¡lido:",rawMap,e);continue}else data_ceca=rawMap;if(null!=data_ceca&&void 0!==data_ceca.lat&&void 0!==data_ceca.lon){const markerCeca=L.marker([data_ceca.lat,data_ceca.lon],{icon:iconoCeca}).bindPopup(`<b>Ceca</b><br>${data.cecas.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasCecas(data.cecas.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.cecas.datos[index],monedas.result),this.openPopup()}));clusterCecas.addLayer(markerCeca)}}if(null!=data.complejos.datos)for(let index=0;index<data.complejos.datos.length;index++){let data_complejos=null;try{data_complejos=JSON.parse(data.complejos.datos[index].map)}catch(error){data_complejos=data.complejos.datos[index].map}if(null!=data_complejos){const markerComplejo=L.marker([data_complejos.lat,data_complejos.lon],{icon:iconoComplejo}).bindPopup(`<b>Complejo</b><br>${data.complejos.datos[index].name}`).on("click",(async function(){const monedas=await map_node.cargarMonedasComplejos(data.complejos.datos[index].name);for(;map_node.rows_container.hasChildNodes();)map_node.rows_container.removeChild(map_node.rows_container.lastChild);map_node.render_rows(data.complejos.datos[index],monedas.result),this.openPopup()}));clusterComplejos.addLayer(markerComplejo)}}map.addLayer(clusterHallazgos),map.addLayer(clusterCecas),map.addLayer(clusterComplejos);const clusters={clusterHallazgos:clusterHallazgos,clusterCecas:clusterCecas,clusterComplejos:clusterComplejos};return clusters},this.create_legend=function(map,clusters){L.control.Legend({position:"bottomleft",collapsed:!1,title:"Leyenda",columns:2,legends:[{label:"Ceca",type:"image",url:this.unique?"../tpl/assets/images/map/IMG_8276.png":"./tpl/assets/images/map/IMG_8276.png",layers:clusters.clusterCecas},{label:"Hallazgo",type:"image",url:this.unique?"../tpl/assets/images/map/orange.png":"./tpl/assets/images/map/orange.png",layers:clusters.clusterHallazgos},{label:"Complejo",type:"image",url:this.unique?"../tpl/assets/images/map/IMG_5962.png":"./tpl/assets/images/map/IMG_5962.png",layers:clusters.clusterComplejos}]}).addTo(map);const drawnItems=new L.FeatureGroup;function cargarRutasCache(){const rutasCache=localStorage.getItem("rutas");if(rutasCache){console.log("RUTAS CACHE",rutasCache);const data=JSON.parse(rutasCache);L.geoJSON(data,{style:function(feature){return{color:feature.properties.color||"blue",weight:6,dashArray:"5,5"}}}).eachLayer(layer=>drawnItems.addLayer(layer))}else console.log("No hay rutas en cache aÃºn.")}if(map.addLayer(drawnItems),cargarRutasCache(),this.DEV_MODE){const drawControl=new L.Control.Draw({draw:{polyline:{shapeOptions:{color:"green",weight:2},repeatMode:!1},polygon:!1,rectangle:!1,circle:!1,marker:!1},edit:{featureGroup:drawnItems}});map.addControl(drawControl),map.on(L.Draw.Event.CREATED,(function(e){const layer=e.layer;layer.feature=layer.feature||{type:"Feature",properties:{}},layer.feature.properties.color="green",drawnItems.addLayer(layer)}));const GuardarControl=L.Control.extend({options:{position:"topleft"},onAdd:function(map){const container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");return container.style.backgroundColor="white",container.style.padding="5px",container.style.cursor="pointer",container.innerHTML="ðŸ’¾ Guardar",container.onclick=function(){const geojsonData=drawnItems.toGeoJSON();localStorage.setItem("rutas",JSON.stringify(geojsonData)),alert("Rutas guardadas en cache correctamente")},container}});map.addControl(new GuardarControl)}},this.move_map_to_point=function(location){this.map.setView([location.lat,location.lon],14)}}